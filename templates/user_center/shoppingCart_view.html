
{% extends "user_center/base.html" %}
{% load custom_filters %}
{% load static %}
{% block title %}Shopping Cart{% endblock %}
{% block extra_head %}
<style>
    .main-content {
        margin-bottom: 100px; /* 调整这个值以确保底部有足够的空间 */
    }
    /* 下面四个是关于报价单的样式， 在modal中 */
    .table-header {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    .table-title {
        font-size: 24px;
        text-align: center;
        font-weight: bold;
        padding: 20px 0;
    }
    .col-seq {
        width: 5%;  /* 第一列：序号，设置为5% */
    }
    .col-item {
        width: 20%; /* 第二列：项目，设置为25% */
    }
    .col-dis {
        width: 7%; /* 第八列：折扣率，设置为10% */
    }
    .text-bg-purple {
        background-color: #e4b9f8;
        color: black;
    }
</style>
{% endblock %}
{% block content %}

<!-- Modal for bulk optimization settings -->
<div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" id="bulkOptimizationModal" tabindex="-1" aria-labelledby="bulkOptimizationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkOptimizationModalLabel">Bulk Optimization Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Select Genes -->
                <div class="card mb-4 shadow-sm border-primary">
                    <div class="card-header bg-primary text-white">
                        Step 1: Select Genes that you want to optimize
                    </div>
                    <div class="card-body">
                        <table id="gene-table-datatable" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th></th> <!-- For Select Checkboxes -->
                                    <th>#</th>
                                    <th>GeneName</th>
                                    <th>SeqType</th>
                                    <th>Vector</th>
                                    <th>Sequence Status</th>
                                    <th>Optimization Status</th>
                                    <th>Length</th>
                                    <th>GC%</th>
                                    <th>Penalty</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for group in grouped_shopping_cart %}
                            {% for gene in group.genes %}
                                <tr data-gene-id="{{ gene.id }}"> <!-- Use data attribute to store gene ID -->
                                    <td></td> <!-- DataTables will render checkboxes here -->
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ gene.gene_name }}</td>
                                    <td>
                                        {% if gene.seq_type == 'NT' %}
                                            <span class="badge rounded-pill text-bg-info">NT</span>
                                        {% else %}
                                            <span class="badge rounded-pill" style="background-color: #e4b9f8; color: black;">{{ gene.seq_type }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ gene.vector.vector_name }}</td>
                                    <td>
                                        {% if gene.status == 'forbidden' %}
                                            <span class="badge rounded-pill" style="background-color: #dc3545;">Forbidden</span>
                                        {% elif gene.status == 'validated' %}
                                            <span class="badge rounded-pill" style="background-color: #198754;">Validated</span>
                                        {% elif gene.status == 'warning' %}
                                            <span class="badge rounded-pill" style="background-color: #fd7e14;">Warning</span>
                                        {% elif gene.status == 'error' %}
                                            <span class="badge rounded-pill" style="background-color: #880808;">Error</span>
                                        {% else %}
                                            <span class="badge  rounded-pill bg-secondary">{{ gene.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if gene.optimization_status == 'Pending' %}
                                            <span class="badge" style="background-color: #6c757d;">{{ gene.optimization_status }}</span>
                                        {% elif gene.optimization_status == 'Optimizing' %}
                                            <span class="badge" style="background-color: #0d6efd;">{{ gene.optimization_status }}</span>
                                        {% elif gene.optimization_status == 'NotOptimized' %}
                                            <span class="badge" style="background-color: #ffc107;">{{ gene.optimization_status }}</span>
                                        {% elif gene.optimization_status == 'Optimized' %}
                                            <span class="badge" style="background-color: #198754;">{{ gene.optimization_status }}</span>
                                        {% elif gene.optimization_status == 'NeedsOptimization' %}
                                            <span class="badge" style="background-color: #fd7e14">{{ gene.optimization_status }}</span>
                                        {% elif gene.optimization_status == 'OptimizeFailed' %}
                                            <span class="badge" style="background-color: #dc3545;">{{ gene.optimization_status }}</span>
                                        {% elif gene.optimization_status == 'Skipped' %}
                                            <span class="badge" style="background-color: #0dcaf0;">{{ gene.optimization_status }}</span>
                                        {% elif gene.optimization_status == 'Error' %}
                                            <span class="badge" style="background-color: #880808;">{{ gene.optimization_status }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ gene.optimization_status }}</span>
                                        {% endif %}
                                    <td>{{ gene.original_seq|length }}</td>
                                    <td>{{ gene.original_gc_content|floatformat }}</td>
                                    <td>{{ gene.penalty_score }}</td>
                                </tr>
                            {% endfor %}
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Step 2: Select Species -->
                <div class="card mb-4 shadow-sm border-success">
                    <div class="card-header bg-success text-white">
                        Step 2: Choose a Species
                    </div>
                    <div class="card-body">
                        <label for="speciesSelect" class="form-label">Choose a species for all selected genes.</label>
                        <select class="form-select" id="speciesSelect" name="species_select_for_optimization">
                            <option value="" selected>Choose a species</option>
                            {% for species in species_names %}
                                <option value="{{ species }}">{{ species }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Step 3: Select Optimization Method -->
                <div class="card mb-4 shadow-sm border-info">
                    <div class="card-header bg-info text-white">
                        Step 3: Choose an Optimization Method
                    </div>
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="optimization_method" id="method1" value="1" checked>
                            <label class="form-check-label" for="method1">
                                Method 1: Only Optimize Forbidden Sequences(ForbdSeqOlny)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="optimization_method" id="method2" value="2">
                            <label class="form-check-label" for="method2">
                                Method 2: Optimize slightly (No folding Check)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="optimization_method" id="method3" value="3">
                            <label class="form-check-label" for="method3">
                                Method 3: Full Optimization (LongGene_Relaxed)
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <form id="bulkOptimizationForm" action="{% url 'user_center:bulk_optimization_submit' %}" method="post">
                    {% csrf_token %}
                    <!-- Hidden input to store selected genes -->
                    <input type="hidden" id="selectedGenes" name="selected_genes">
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary">Submit</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- main content -->
<div class="container-fluid main-content">
    <!-- Breadcrumb -->
    <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb" class="mt-2">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'user_center:dashboard' %}" class="text-decoration-none">User Center</a></li>
            <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
        </ol>
    </nav>
    <!-- End Breadcrumb -->
    <div class="row pt-3 mt-3 form-control d-flex justify-content-between align-items-center">
        <!-- header -->
        <div class="row">
            <div class="col-6">
                <h4 class="mb-3"><i class="bi bi-list-ul"></i> Shopping Cart</h4>
            </div>
            <div class="col-6 text-end">
                <a href="{% url 'user_center:order_create' %}" class="btn btn-outline-primary">
                    <i class="bi bi-clipboard-plus me-2"></i> Add More</a>
            </div>
        </div>
        <!-- select Status form-->
        <div class="row">
            <div class="col-md-4">
                <select class="form-control" id="statusFilter">
                    <option value="all">All Statuses</option>
                    <option value="forbidden">Forbidden</option>
                    <option value="validated">Validated</option>
                    <option value="optimizing">Optimizing</option>
                    <option value="optimized">Optimized</option>
                    <option value="Error">Error</option>
                    <option value="forbidden">Forbidden</option>
                    <!-- 其他状态 -->
                </select>
            </div>
        </div>
        <!-- Table -->
        <table class="table table-striped table-hover" style="text-align:center" id="shopping-cart-table">
            <thead>
                <tr>
                    <th scope="col"><input type="checkbox" id="selectAllTop" name="gene_id" value="all"></th>
                    <th scope="col">ID</th>
                    <th scope="col">Name</th>
                    <th scope="col">SeqType</th>
                    <th scope="col">Vector</th>
                    <th scope="col">Species</th>
                    <th scope="col">Sequence Status</th>
                    <th scope="col">Length(AA/NT)</th>
                    <th scope="col">GC%</th>
                    <th scope="col">Optimization Status</th>
                    <th scope="col">Penalty Score</th>
                    <th scope="col">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for group in grouped_shopping_cart %}
                <tr class="date-header">
                    <td class="table-info" > 
                        <input type="checkbox" class="date-select-checkbox" data-date="{{ group.date }}"> 
                    </td>
                    <td colspan="11" class="table-info text-start"> {{ group.date }}</td>
                </tr>
                {% for gene in group.genes %}
                <tr data-status="{{ gene.status }}" data-optimization-status="{{ gene.optimization_status }}">
                    <td>
                        <!-- 复选框 -->
                        <input type="checkbox" class="gene-checkbox" name="gene_id" value="{{ gene.id }}" 
                            data-length="{% if gene.seq_type == 'NT' %}{{ gene.saved_seq|safe|base_length }}{% else %}{{ gene.saved_seq|safe|base_length|multiply:3 }}{% endif %}" 
                            data-date="{{ group.date }}" 
                            data-vector="{{ gene.vector }}">
                    </td>
                    
                    <td>{{ forloop.counter }}</td>
                    <td>
                        <!-- 基因名称 -->
                        <a data-bs-toggle="tooltip" data-bs-replacement="top" title="See Details" 
                            href="{% url 'user_center:gene_edit' gene.id %}" class="text-decoration-none">
                            {{ gene.gene_name }}
                        </a>
                    </td>
                    <td>
                        {% if gene.seq_type == 'NT' %}
                            <span class="badge rounded-pill text-bg-info">NT</span>
                        {% else %}
                            <span class="badge rounded-pill text-bg-purple">{{ gene.seq_type }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="">{{ gene.vector }} </span>
                    </td>
                    <td>{{ gene.species }}</td>
                    <td> 
                        {% if gene.status == 'forbidden' %}
                            <span class="badge rounded-pill" style="background-color: #dc3545;" data-bs-toggle="tooltip" data-bs-replacement="top" title="Forbidden sequence, can be optimized">
                                Forbidden</span>
                        {% elif gene.status == 'validated' %}
                            <span class="badge rounded-pill" style="background-color: #198754;" data-bs-toggle="tooltip" data-bs-replacement="top" title="validated sequence, good">
                                Validated</span>
                        {% elif gene.status == 'warning' %}
                            <span class="badge rounded-pill" style="background-color: #fd7e14;" data-bs-toggle="tooltip" data-bs-replacement="top" title="Warning: Better to optimize">
                                Warning</span>
                        {% elif gene.status == 'error' %}
                            <span class="badge rounded-pill" style="background-color: #880808;" data-bs-toggle="tooltip" data-bs-replacement="top" title="Error: Please fix your sequence first">
                                Error</span>
                        {% else %}
                            <span class="badge bg-secondary rounded-pill">{{ gene.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <!-- 基因长度 -->
                         {% if gene.seq_type == 'NT' %}
                            {{ gene.saved_seq|safe|base_length }}bp
                        {% elif gene.seq_type == 'AA' %}
                            {{ gene.original_seq|safe|base_length }}/{{ gene.original_seq|safe|base_length|multiply:3 }}bp
                        {% endif %}
                    </td>
                    <td>
                        <!-- GC含量 -->
                        {% if gene.seq_type == 'AA' and not gene.saved_seq %}
                            -
                        {% else %}
                            {{ gene.modified_gc_content }}%
                        {% endif %}
                    </td>
                    <td>
                        {% if gene.optimization_status == 'Pending' %}
                            <span class="badge rounded-pill" style="background-color: #6c757d;">{{ gene.optimization_status }}</span>
                        {% elif gene.optimization_status == 'Optimizing' %}
                            <span class="badge rounded-pill" style="background-color: #0d6efd;">{{ gene.optimization_status }}</span>
                        {% elif gene.optimization_status == 'NotOptimized' %}
                            {% if gene.status == 'warning' %}
                                <span class="badge rounded-pill" style="background-color: #fd7e14;" data-bs-toggle="tooltip" data-bs-replacement="top" title="Optimization Suggestion: Better to Optimize">
                                    {{ gene.optimization_status }}</span>
                            {% else %}
                                <span class="badge rounded-pill" style="background-color: #ffc107;" data-bs-toggle="tooltip" data-bs-replacement="top" title="Optimization Suggestion: Up to You">
                                    {{ gene.optimization_status }}</span>
                            {% endif %}
                        {% elif gene.optimization_status == 'Optimized' %}
                            <span class="badge rounded-pill" style="background-color: #198754;">{{ gene.optimization_status }}</span>
                        {% elif gene.optimization_status == 'NeedsOptimization' %}
                            <span class="badge rounded-pill" style="background-color: #fd7e14" data-bs-toggle="tooltip" data-bs-replacement="top" title="Must do Optimization first before submission">
                                {{ gene.optimization_status }}</span>
                        {% elif gene.optimization_status == 'OptimizeFailed' %}
                            <span class="badge rounded-pill" style="background-color: #dc3545;">{{ gene.optimization_status }}</span>
                        {% elif gene.optimization_status == 'Skipped' %}
                            <span class="badge rounded-pill" style="background-color: #0dcaf0;">{{ gene.optimization_status }}</span>
                        {% elif gene.optimization_status == 'failed' %}
                            <span class="badge rounded-pill" style="background-color: #880808;" data-bs-toggle="tooltip" data-bs-replacement="top" title="{{gene.optimization_message}}">
                                {{ gene.optimization_status }}</span>
                        {% else %}
                            <span class="badge rounded-pill" style="background-color: #880808;" data-bs-toggle="tooltip" data-bs-replacement="top" title="Can not optimize unitil you fix your sequence first.">
                                {{ gene.optimization_status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <!-- Penalty Score -->
                        {{ gene.penalty_score }}
                    </td>
                    <td>
                        {% if gene.status == 'optimizing' or gene.status == 'optimized' or gene.status == 'failed' %}
                            <a data-bs-toggle="tooltip" data-bs-replacement="top" title="See detail" 
                                href="{% url 'user_center:protein_edit' gene.id %}" class="text-decoration-none">
                                <i class="bi bi-eye me-2"></i>
                            </a>
                        {% else %}
                            <a data-bs-toggle="tooltip" data-bs-replacement="top" title="Download GenBank File" 
                                href="{% url 'user_center:cart_genbank_download' gene.id %}" 
                                class="text-decoration-none">
                                <i class="bi bi-download me-2"></i>
                            </a>
                        {% endif %}
                        <a data-bs-toggle="tooltip" data-bs-replacement="top" title="Delete item" 
                            href="javascript:" onclick="del_gene(this, {{ gene.id }})" class="text-decoration-none">
                            <i class="bi bi-trash text-danger me-2"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Fixed bottom checkout bar -->
<div class="container-fluid fixed-bottom" style="background-color: #f5d0fa;">
    <div class="row mt-3 mb-3">
        <!-- left -->
        <div class="col-lg-5">
            <!-- check box and delete button -->
            <div class="d-flex align-items-center justify-content-end">
                <input type="checkbox" id="selectAllBottom" name="gene_id" value="all">
                <label class="form-check-label ms-2 me-3" for="selectAllBottom">Select All</label>
                
                <button class="btn btn-outline-success me-3" id="codonOptimizeButton" data-bs-toggle="modal" data-bs-target="#bulkOptimizationModal">
                    <i class="bi bi-sliders"></i> Codon Optimize
                </button>
                
                <!-- Card with three buttons -->
                <div class="card mt-1 mb-2" style="width: auto; height: auto;">
                    <div class="card-body me-2 p-2 d-inline-block" style="width: 158px;height: 35px;"> <!-- Adjust width as needed -->
                        <div class="d-flex justify-content-around p-0">
                            
                            <button onclick="bulkViewSelectedGeneDetails()" class="btn btn-link p-0" data-bs-toggle="tooltip" data-bs-replacement="top" title="View Details for selected items">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button onclick="bulkdownloadSelectedGenBank()" class="btn btn-link p-0" data-bs-toggle="tooltip" data-bs-replacement="top" title="Download GenBank Files for selected items">
                                <i class="bi bi-cloud-download"></i>
                            </button>
                            <button onclick="bulkDownloadSelectedExcelInfo()" class="btn btn-link p-0" data-bs-toggle="tooltip" data-bs-replacement="top" title="Download detail information for selected items in Excel format">
                                <i class="bi bi-filetype-xlsx"></i>
                            </button>
                            <button onclick="deleteSelected()" class="btn btn-link text-danger p-0" data-bs-toggle="tooltip" data-bs-replacement="top" title="Delete selected items">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- center -->
        <div class="col-lg-4 d-flex flex-column">
            <div class="d-flex justify-content-between mb-1">
                <p id="total-genes" class="mb-0">Total 0 Genes</p>
                <p class="mb-0">Delivery:
                    <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Depends on your location. Please fill in your shipping address in your account's profile."></i></p>
                <p id="total-price" class="mb-0">Total: ￥0</p>
            </div>
            <div class="d-flex justify-content-between">
                <p id="total-length" class="mb-0">Total 0 bp</p>
                <p id="delivery-fee" class="mb-0">￥0 delivery fee</p>
                <p class="mb-0">
                    <a class="text-decoration-none" href="#" data-bs-toggle="modal" data-bs-target="#detailsModal">See details <i class="bi bi-caret-down-fill"></i></a>
                </p>
            </div>
        </div>
        <!-- right -->
        <div class="col-lg-3 d-flex align-items-center justify-content-center">
            <button type="button" class="btn btn-primary" id="checkoutButton">
                <i class="bi bi-check2-square me-1"></i>Submit
            </button>
        </div>
    </div>
</div>

<!-- Modal for price detail -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered table-sm" id="price-detail-table">
                    <!-- 标题行 -->
                    <tr><td colspan="8" class="table-title">基因合成报价单</td></tr>
                    <!-- 基因合成报价信息（<450 bp） -->
                    <tr><td colspan="8" class="table-header table-active">基因合成报价信息（<450 bp）</td></tr>
                    <tr class="table-header">
                        <td class="text-center col-seq">序号</td>
                        <td class="text-center col-item">项目</td>
                        <td class="text-center">单位</td>
                        <td class="text-center">数量</td>
                        <td class="text-center">含税单价（元）</td>
                        <td class="text-center">总价（元）</td>
                        <td class="text-center">合计（元）</td>
                        <td class="text-center">优惠后合计（元）</td>
                        <td class="text-center col-dis">折扣率</td>
                        <!-- <td class="text-center">折扣单价</td> -->
                    </tr>
                    <tr>
                        <td rowspan="2" class="align-middle text-center">1</td>
                        <td>基因合成</td>
                        <td class="text-center">个</td>
                        <td class="text-center" contenteditable="true" id="length-group-450"></td>
                        <td class="text-center">90</td>
                        <td class="text-center">0.00</td>
                        <td rowspan="2" class="align-middle text-center">0.00</td>
                        <td rowspan="2" class="align-middle text-center">0.00</td>
                        <td rowspan="2" class="align-middle text-center" contenteditable="true">1</td>
                        <!-- <td rowspan="2" class="align-middle text-center"></td> -->
                    </tr>
                    <tr>
                        <td>载体克隆及NGS测序验证</td>
                        <td class="text-center">个</td>
                        <td class="text-center" contenteditable="true" id="count-group-450"></td>
                        <td class="text-center">50</td>
                        <td class="text-center">0.00</td>
                    </tr>

                    <!-- 基因合成报价信息（450 - 3000 bp） -->
                    <tr><td colspan="8" class="table-header table-active">基因合成报价信息（450 - 3000 bp）</td></tr>
                    <tr>
                        <td rowspan="2" class="align-middle text-center">2</td>
                        <td>基因合成</td>
                        <td class="text-center">bp</td>
                        <td class="text-center" contenteditable="true" id="length-group-450-3000"></td>
                        <td class="text-center">0.3</td>
                        <td class="text-center">0.00</td>
                        <td rowspan="2" class="align-middle text-center">0.00</td>
                        <td rowspan="2" class="align-middle text-center">0.00</td>
                        <td rowspan="2" class="align-middle text-center" contenteditable="true">1</td>
                        <!-- <td rowspan="2" class="align-middle text-center"></td> -->
                    </tr>
                    <tr>
                        <td>载体克隆及NGS测序验证</td>
                        <td class="text-center">个</td>
                        <td class="text-center" contenteditable="true" id="count-group-450-3000"></td>
                        <td class="text-center">150</td>
                        <td class="text-center">0.00</td>
                    </tr>

                    <!-- 基因合成报价信息（3001 - 5000 bp） -->
                    <tr><td colspan="8" class="table-header table-active">基因合成报价信息（3001 - 5000 bp）</td></tr>
                    <tr>
                        <td rowspan="2" class="align-middle text-center">3</td>
                        <td>基因合成</td>
                        <td class="text-center">bp</td>
                        <td class="text-center" contenteditable="true" id="length-group-3001-5000"></td>
                        <td class="text-center">0.35</td>
                        <td class="text-center">0.00</td>
                        <td rowspan="2" class="align-middle text-center">0.00</td>
                        <td rowspan="2" class="align-middle text-center">0.00</td>
                        <td rowspan="2" class="align-middle text-center" contenteditable="true">1</td>
                        <!-- <td rowspan="2" class="align-middle text-center"></td> -->
                    </tr>
                    <tr>
                        <td>载体克隆及NGS测序验证</td>
                        <td class="text-center">个</td>
                        <td class="text-center" contenteditable="true" id="count-group-3001-5000"></td>
                        <td class="text-center">300</td>
                        <td class="text-center">0.00</td>
                    </tr>

                    <!-- 基因合成报价信息（5001 - 10 kb） -->
                    <tr><td colspan="8" class="table-header table-active">基因合成报价信息（5001 - 10 kb）</td></tr>
                    <tr>
                        <td rowspan="2" class="align-middle text-center">4</td>
                        <td>基因合成</td>
                        <td class="text-center">bp</td>
                        <td class="text-center" contenteditable="true" id="length-group-5001"></td>
                        <td class="text-center">0.6</td>
                        <td class="text-center">0.00</td>
                        <td rowspan="2" class="align-middle text-center">0.00</td>
                        <td rowspan="2" class="align-middle text-center">0.00</td>
                        <td rowspan="2" class="align-middle text-center" contenteditable="true">1</td>
                        <!-- <td rowspan="2" class="align-middle text-center"></td> -->
                    </tr>
                    <tr>
                        <td>载体克隆及NGS测序验证</td>
                        <td class="text-center">个</td>
                        <td class="text-center" contenteditable="true" id="count-group-5001"></td>
                        <td class="text-center">500</td>
                        <td class="text-center">0.00</td>
                    </tr>

                    <!-- 其他费用 -->
                    <tr><td colspan="8" class="table-header table-active">其他费用</td></tr>
                    <tr>
                        <td class="text-center">5</td>
                        <td>载体构建</td>
                        <td class="text-center">个</td>
                        <td class="text-center" contenteditable="true"></td>
                        <td class="text-center">2000</td>
                        <td class="text-center">0.00</td>
                        <td colspan="2" class="text-center">/</td>
                    </tr>
                    <tr>
                        <td class="text-center">6</td>
                        <td>甘油菌</td>
                        <td class="text-center">个</td>
                        <td class="text-center" contenteditable="true" id="total-count"></td>
                        <td class="text-center">20</td>
                        <td class="text-center">0.00</td>
                        <td colspan="2" class="text-center">/</td>
                    </tr>
                    <tr>
                        <td class="text-center">7</td>
                        <td>干冰运输</td>
                        <td class="text-center">趟</td>
                        <td class="text-center" contenteditable="true"></td>
                        <td class="text-center">500</td>
                        <td class="text-center">0.00</td>
                        <td colspan="2" class="text-center">/</td>
                    </tr>

                    <!-- 总价-->
                    <tr><td colspan="8" class="table-header table-active">总价</td></tr>
                    <tr><td colspan="8" class="text-center">优惠前总价（元）：<del id="total-before-discount"></del></td></tr>
                    <tr><td colspan="8" class="text-center table-active" style="background-color: #FF85FF;">优惠后总价（元）：<strong id="total-after-discount"></strong></td></tr>

                    <!-- 交付信息 -->
                    <tr><td colspan="8" class="table-header">交付信息</td></tr>
                    <tr><td colspan="8" contenteditable="true">交付：提供的 <strong> <span id="total-count-display"></span> </strong>个基因片段，构建载体为 ：<strong><span id="vector-list"></span></strong>，
                        交付形式 : <strong>质粒溶液</strong>, 交付容器：<strong>单管 </strong>。<br> 周期：<strong>5-7周</strong></td></tr>

                    <!-- 报价说明 -->
                    <tr><td colspan="8" class="table-header">报价说明</td></tr>
                    <tr>
                        <td colspan="8">
                            1. 订单生产以邮件确认为开始，视为产品生产开始日期。<br>
                            2. 交付周期包含产品运输时间，不包含客户指定载体的改造时间；指定载体改造所需时间由改造内容而定。<br>
                            3. 以上报价仅在有效期内有效。<br>
                            4. 报价单如与最终签署的合同价格不一致，以合同金额为准。<br>
                            5. 订单交付后，乙方仅保存少量质粒和菌液（如有），用于QC验证，不做他用；订单全部交付的2个月后，乙方将销毁该订单相关的序列信息、质粒及菌液（如有）。<br>
                            6. 关于取消订单：<br>
                            （i）若客户于邮件确认后1周内提出取消要求，须支付订单总价的20%；<br>
                            （ii）若客户于邮件确认1周后至4周内提出取消要求，须支付订单总价的80%；<br>
                            （iii）若客户于邮件确认4周后至整个订单已经完成时提出取消要求，须支付订单总价的100%。
                        </td>
                    </tr>

                    <!-- 公司信息 -->
                    <tr><td colspan="8" class="table-header">公司信息</td></tr>
                    <tr>
                        <td colspan="8">
                            广州呈源生物免疫技术有限公司<br>
                            地址：广东省广州市黄埔区神舟路18号F栋13楼<br>
                            联系人：方磊<br>
                            电话：13316120226<br>
                            邮箱：<a href="mailto:order@rootpathgx.com">order@rootpathgx.com</a>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const priceTable = {
            '0-99': {
                '<450': 135,
                '450-3000': 0.3,
                '3001-5000': 0.35,
                '>5001': 0.6
            },
            '100-299': {
                '<450': 112.5,
                '450-3000': 0.25,
                '3001-5000': 0.3,
                '>5001': 0.5
            },
            '>300': {
                '<450': 90,
                '450-3000': 0.2,
                '3001-5000': 0.25,
                '>5001': 0.4
            }
        };
        
        function getPriceGroup(totalCounts) {
            if (totalCounts <= 99) {
                return priceTable['0-99'];
            } else if (totalCounts <= 299) {
                return priceTable['100-299'];
            } else {
                return priceTable['>300'];
            }
        }

        var lengthGroups = {
            '<450': { count: 0, length: 0 },
            '450-3000': { count: 0, length: 0 },
            '3001-5000': { count: 0, length: 0 },
            '>5001': { count: 0, length: 0 }
        };

        var totalBeforeDiscount = 0;
        var totalAfterDiscount = 0;

        function calculatePricesAndLengths() {
            // 初始化分类
            lengthGroups = {
                '<450': { count: 0, length: 0 },
                '450-3000': { count: 0, length: 0 },
                '3001-5000': { count: 0, length: 0 },
                '>5001': { count: 0, length: 0 }
            };

            // 用于统计选中的 vector 类型
            const selectedVectors = new Set();

            // 处理选中的基因复选框
            $('input.gene-checkbox:checked:visible').each(function() {
                var length = $(this).data('length');
                var group = length < 450 ? '<450' : length < 3001 ? '450-3000' : length < 5001 ? '3001-5000' : '>5001';
                lengthGroups[group].count++;
                lengthGroups[group].length += length;  

                // 将 vector 类型添加到集合中
                var vectorType = $(this).data('vector');
                if (vectorType) {
                    selectedVectors.add(vectorType);
                }
            });

            // 更新表格，但只更新没有手动修改过的单元格
            updateCellContent('#length-group-450', lengthGroups['<450'].count);
            updateCellContent('#length-group-450-3000', lengthGroups['450-3000'].length);
            updateCellContent('#length-group-3001-5000', lengthGroups['3001-5000'].length);
            updateCellContent('#length-group-5001', lengthGroups['>5001'].length);
            updateCellContent('#count-group-450', lengthGroups['<450'].count);
            updateCellContent('#count-group-450-3000', lengthGroups['450-3000'].count);
            updateCellContent('#count-group-3001-5000', lengthGroups['3001-5000'].count);
            updateCellContent('#count-group-5001', lengthGroups['>5001'].count);

            // 返回当前的总长度 和总数量
            totalLength = lengthGroups['<450'].length + lengthGroups['450-3000'].length + lengthGroups['3001-5000'].length + lengthGroups['>5001'].length;
            totalCounts = lengthGroups['<450'].count + lengthGroups['450-3000'].count + lengthGroups['3001-5000'].count + lengthGroups['>5001'].count;
            document.querySelector('#total-count').textContent = totalCounts;

            // 将所有选中的 vector 类型显示在某个地方（假设有一个容器 id 为 `vector-list`）
            document.querySelector('#vector-list').textContent = Array.from(selectedVectors).join(', ');

            return totalLength;
        }

        // 辅助函数：仅在单元格未被手动修改时更新内容
        function updateCellContent(selector, value) {
            const cell = document.querySelector(selector);
            if (!cell.getAttribute('data-edited')) {  // 仅在未被手动编辑的情况下更新
                cell.textContent = value;
            }
        }

        // 设置监听器，用户手动编辑单元格后进行标记
        function setupContentEditableListeners() {
            document.querySelectorAll('[contenteditable="true"]').forEach(cell => {
                // 在聚焦时也标记单元格为可编辑，确保首次点击即可编辑
                cell.addEventListener('focus', function() {
                    this.setAttribute('data-edited', 'true');  // 聚焦时立即标记
                });

                // 监听失去焦点时的事件，更新总价
                cell.addEventListener('blur', function() {
                    updateTotalPrice();  // 手动编辑后重新计算总价
                });
            });
        }

        function updateFinalTotal() {
            let geneTotal = 0;
            let geneDiscountTotal = 0;

            // 获取当前总的基因数量
            const totalCounts = parseFloat(document.querySelector('#total-count').textContent) || 0;

            // 获取适用的单价表
            const priceGroup = getPriceGroup(totalCounts);

            // 获取所有的表格行
            const rows = document.querySelectorAll('#price-detail-table tr');
            rows.forEach((row, index) => {
                // 只处理含有合并行（rowspan=2）的部分，即每个基因合成项目的主行
                if (index > 2 && row.querySelector('[rowspan="2"]')) {
                    const quantityCell1 = row.querySelector('td:nth-child(4)'); // 第一行数量单元格
                    const unitPriceCell1 = row.querySelector('td:nth-child(5)'); // 第一行单价单元格
                    const totalPriceCell1 = row.querySelector('td:nth-child(6)'); // 第一行总价单元格

                    const nextRow = row.nextElementSibling; // 获取第二行
                    const quantityCell2 = nextRow.querySelector('td:nth-child(3)'); // 第二行数量单元格
                    const unitPriceCell2 = nextRow.querySelector('td:nth-child(4)'); // 第二行单价单元格
                    const totalPriceCell2 = nextRow.querySelector('td:nth-child(5)'); // 第二行总价单元格

                    const totalCell = row.querySelector('td:nth-child(7)'); // 合计单元格
                    const discountTotalCell = row.querySelector('td:nth-child(8)'); // 优惠后合计单元格
                    const discountRateCell = row.querySelector('td:nth-child(9)'); // 折扣率单元格

                    const quantity1 = parseFloat(quantityCell1.textContent) || 0;
                    const lengthCategory1 = lengthCategory(parseFloat(unitPriceCell2.textContent) || 0);  // 根据单价获取长度区间
                    const unitPrice1 = priceGroup[lengthCategory1] || 0;  // 根据数量获取单价

                    const quantity2 = parseFloat(quantityCell2.textContent) || 0;
                    const unitPrice2 = parseFloat(unitPriceCell2.textContent) || 0;

                    // 更新单价
                    unitPriceCell1.textContent = unitPrice1.toFixed(2);

                    const totalPrice1 = quantity1 * unitPrice1;
                    const totalPrice2 = quantity2 * unitPrice2;

                    // 更新单元格显示总价
                    totalPriceCell1.textContent = totalPrice1.toFixed(2);
                    totalPriceCell2.textContent = totalPrice2.toFixed(2);

                    // 计算合计
                    const total = totalPrice1 + totalPrice2;
                    totalCell.textContent = total.toFixed(2);

                    // 获取折扣率并计算优惠后总价
                    const discountRate = parseFloat(discountRateCell.textContent) || 1; // 默认折扣率为1
                    const discountTotal = total * discountRate;
                    discountTotalCell.textContent = discountTotal.toFixed(2);

                    // 将当前部分的总价和折扣总价累计
                    geneTotal += total;
                    geneDiscountTotal += discountTotal;
                }
            });

            let otherTotal = 0;
            const otherRows = [
                { selector: '载体构建', index: 15 },
                { selector: '甘油菌', index: 16 },
                { selector: '干冰运输', index: 17 }
            ];

            otherRows.forEach(({ index }) => {
                const row = rows[index];
                const quantityCell = row.querySelector('td:nth-child(4)'); // 数量单元格
                const unitPriceCell = row.querySelector('td:nth-child(5)'); // 单价单价单元格
                const totalPriceCell = row.querySelector('td:nth-child(6)'); // 总价单元格

                // 计算其他部分的总价
                const quantity = parseFloat(quantityCell.textContent) || 0;
                const unitPrice = parseFloat(unitPriceCell.textContent) || 0;
                const totalPrice = quantity * unitPrice;
                // 更新单元格显示总价    
                totalPriceCell.textContent = totalPrice.toFixed(2);

                // 累加到其他部分的总价
                otherTotal += totalPrice;
            });

            totalBeforeDiscount = geneTotal + otherTotal;
            totalAfterDiscount = geneDiscountTotal + otherTotal;

            document.querySelector('#total-before-discount').textContent = totalBeforeDiscount.toFixed(2);
            document.querySelector('#total-after-discount').textContent = totalAfterDiscount.toFixed(2);
        }

        // 辅助函数，用于确定长度区间
        function lengthCategory(length) {
            if (length == 50) {
                return '<450';
            } else if (length == 150) {
                return '450-3000';
            } else if (length == 300) {
                return '3001-5000';
            } else {
                return '>5001';
            }
        }

        function updateTotalPrice() {
            const totalLength = calculatePricesAndLengths(); // 先更新分类
            // 从可编辑的单元格中获取当前的值
            const count450 = parseFloat(document.querySelector('#count-group-450').textContent) || 0;
            const count450_3000 = parseFloat(document.querySelector('#count-group-450-3000').textContent) || 0;
            const count3001_5000 = parseFloat(document.querySelector('#count-group-3001-5000').textContent) || 0;
            const count5001 = parseFloat(document.querySelector('#count-group-5001').textContent) || 0;

            // 计算总数
            const totalCounts = count450 + count450_3000 + count3001_5000 + count5001;

            // 更新页面上显示的总数
            document.querySelector('#total-count').textContent = totalCounts;
            // 更新"提供的基因片段数"
            document.querySelector('#total-count-display').textContent = totalCounts;

            // 更新其他总价等信息
            updateFinalTotal(); // 再更新总价

            const totalPrice = totalBeforeDiscount || 0;

            // 更新页面显示
            $('#total-price').text('Total ￥: ≈' + totalPrice.toFixed(2));
            $('#total-genes').text('Total ' + $('input.gene-checkbox:checked:visible').length + ' Genes');
            $('#total-length').text('Total ' + totalLength + ' bp');
        }

        setupContentEditableListeners();  // 设置监听器

        // 监听复选框状态变化，实时更新分类和总价
        $('input.gene-checkbox').change(function() {
            updateTotalPrice();
        });

        // 为可编辑的数量、单价、折扣率单元格添加事件监听器，更新总价
        $('#price-detail-table').on('input', 'td', function() {
            updateTotalPrice();
        });

        // 监听全选复选框
        $('#selectAllTop, #selectAllBottom').click(function() {
            const state = this.checked;
            $('input[name="gene_id"]:not(.modal .gene-checkbox)').each(function() {
                if (!this.disabled && $(this).closest('tr').css('display') !== 'none') {
                    this.checked = state;
                }
            });
            $('#selectAllTop, #selectAllBottom').prop('checked', state);
            updateTotalPrice();
        });

        // 监听日期复选框
        $('.date-select-checkbox').on('click', function() {
            const date = $(this).data('date');
            const isChecked = this.checked;
            $('.gene-checkbox[data-date="' + date + '"]:visible').each(function() {
                if (!this.disabled) {
                    this.checked = isChecked;
                }
            });
            updateTotalPrice();
        });

        // 监听状态筛选器的变化
        $('#statusFilter').on('change', function() {
            const selectedStatus = this.value;
            $('tbody tr[data-status]').each(function() {
                $(this).toggle(selectedStatus === 'all' || $(this).data('status') === selectedStatus);
            });
            updateTotalPrice();
        });

        // 提交按钮处理
        $('#checkoutButton').on('click', function () {
            const selectedGenes = $('input.gene-checkbox:checked').map(function () {
                return this.value;
            }).get();

            if (selectedGenes.length === 0) {
                alert('Please select at least one item!');
                return;
            }

            // 遍历选中基因的状态
            let hasForbidden = false;
            let hasNeedsOptimization = false;
            let hasOptimizing = false;
            let hasOptimizeFailed = false;
            let hasError = false;

            $('input.gene-checkbox:checked').each(function () {
                const row = $(this).closest('tr');
                const sequenceStatus = row.data('status'); // 序列状态
                const optimizationStatus = row.data('optimization-status'); // 优化状态

                if (sequenceStatus === 'forbidden' && optimizationStatus !== 'Optimized') {
                    hasForbidden = true;
                }
                if (optimizationStatus === 'NeedsOptimization') {
                    hasNeedsOptimization = true;
                }
                if (optimizationStatus === 'Optimizing') {
                    hasOptimizing = true;
                }
                if (optimizationStatus === 'OptimizeFailed') {
                    hasOptimizeFailed = true;
                }
                if (sequenceStatus === 'error') {
                    hasError = true;
                }
            });

            // 判断逻辑
            if (hasForbidden) {
                alert('Forbidden items must be optimized before submission.');
                return;
            }

            if (hasNeedsOptimization) {
                alert('Some items are marked for optimization. Please wait for optimization to complete.');
                return;
            }

            if (hasOptimizing) {
                alert('Some items are still optimizing. Please wait for the optimization to finish.');
                return;
            }

            if (hasOptimizeFailed) {
                alert('Some items failed to optimize. Please retry optimization before submission.');
                return;
            }

            if (hasError) {
                alert('Some items have errors and cannot be submitted. Please fix the issues.');
                return;
            }

            // 提交逻辑
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            selectedGenes.forEach(function (id) {
                formData.append('gene_ids', id);
            });

            fetch('{% url "user_center:checkout" %}', {
                method: 'POST',
                body: formData,
            })
            .then((response) => response.json())
            .then((data) => {
                if (data.status === 'success') {
                    alert('Submit successfully!');
                    window.location.href = data.redirect_url;
                } else {
                    alert(data.message);
                }
            })
            .catch((error) => console.error('Error:', error));
        });
    });
</script>
<script>
    // 删除单个基因
    function del_gene(the, gene_id) {
        layer.open({
            type: 1,
            skin: 'layui-layer-rim',
            area: ['420px', '240px'],
            title: 'Delete',
            content: '<div style="padding: 20px 80px;">Are you sure to delete this item?</div>',
            btn: ['Yes', 'No'],
            btnAlign: 'c',
            yes: function (index, layero) {
                $.ajax({
                    url: "{% url 'user_center:gene_delete' %}",
                    type: "POST",
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'gene_id': gene_id,
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data.status === 'success') {
                            layer.msg('Delete successfully!', { icon: 1 });
                            setTimeout(function () {
                                window.location.reload();
                            }, 1000);
                        } else {
                            layer.msg(data.message, { icon: 2 });
                        }
                    },
                    error: function (xhr, errmsg, err) {
                        layer.msg('Delete failed!', { icon: 2 });
                    }
                });
            },
        })
    };
    // 删除多个基因
    function deleteSelected() {
        var selectedGenes = [];

        // Iterate through selected checkboxes
        $('.gene-checkbox:checked').each(function () {
            selectedGenes.push($(this).val());
        });

        if (selectedGenes.length === 0) {
            alert('Please select at least one item to delete.');
            return;
        }

        var url = "{% url 'user_center:gene_delete' %}" ;
        var itemCount = selectedGenes.length;
        layer.open({
            type: 1,
            skin: 'layui-layer-rim',
            area: ['420px', '240px'],
            title: 'Delete',
            content: '<div style="padding: 20px 80px;">Are you sure you want to delete <span style="color:red"><strong> ' + itemCount + '</strong></span> selected item(s)?</div>',  // Show count in the message
            btn: ['Yes', 'No'],
            btnAlign: 'c',
            yes: function (index, layero) {
                $.ajax({
                    url: url,
                    type: "POST",
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'gene_ids': selectedGenes,
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data.status === 'success') {
                            layer.msg('Delete successfully!', { icon: 1 });
                            setTimeout(function () {
                                window.location.reload();
                            }, 1000);
                        } else {
                            layer.msg(data.message, { icon: 2 });
                        }
                    },
                    error: function (xhr, errmsg, err) {
                        layer.msg('Delete failed!', { icon: 2 });
                    }
                });
            },
        });
    }
    // 获取选中的基因
    function getSelectedValues() {
        var selectedValues = [];
        $('.gene-checkbox:checked').each(function() {
            selectedValues.push($(this).val());
        });
        return selectedValues;
    }

    // 下载GenBank格式文件
    function bulkdownloadSelectedGenBank() {
        const selectedValues = getSelectedValues();
        if (selectedValues.length > 0) {
            fetch('{% url "user_center:bulk_download_genbank" %}', {
                method: 'POST',
                body: JSON.stringify({ 'gene_ids': selectedValues }),
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                 }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => { throw new Error(error.error) });
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'RootPath-Online-Submission-GenBank.zip';
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(error => {
                alert(error.message);
            });
        } else {
            alert("No items selected");
        }
    }
    // 下载Excel格式文件
    function bulkDownloadSelectedExcelInfo() {
        const selectedValues = getSelectedValues();
        if (selectedValues.length > 0) {
            // Example: send data to server
            fetch('{% url "user_center:bulk_download_geneinfo_excel" %}', {
                method: 'POST',
                body: JSON.stringify({ 'gene_ids': selectedValues }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => { throw new Error(error.error) });
                }
                const disposition = response.headers.get('Content-Disposition');
                const filename = disposition ? disposition.split('filename=')[1].replace(/"/g, '') : 'download.xlsx';
                return response.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
        } else {
            alert("No items selected");
        }
    }
    // 查看基因详情
    function bulkViewSelectedGeneDetails() {
        const selectedValues = getSelectedValues();
        if (selectedValues.length > 0) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "user_center:bulk_view_gene_detail" %}';

            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = '{{ csrf_token }}';
            form.appendChild(csrfToken);

            selectedValues.forEach(value => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'gene_ids';
                input.value = value;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
        } else {
            alert("No items selected");
        }
    }
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Custom selectAll button
    const table = $('#gene-table-datatable').DataTable({
        dom: 'Bfrtip',
        buttons: [
            {
                text: 'Select All',
                action: function (e, dt, node, config) {
                    // 根据按钮文本判断当前状态
                    if (node.text() === 'Select All') {
                        // 全选非 Error 行
                        dt.rows().deselect();
                        dt.rows().every(function (rowIdx) {
                            const rowData = this.data();
                            const parser = new DOMParser();
                            const parsedDoc = parser.parseFromString(rowData[6], 'text/html');
                            const optimizationStatus = parsedDoc.body.textContent.trim();
                            if (optimizationStatus !== 'Error') {
                                dt.row(rowIdx).select();
                            }
                        });
                        node.text('Deselect All');
                    } else {
                        // 取消所有选择
                        dt.rows().deselect();
                        node.text('Select All');
                    }
                }
            }
        ],
        columnDefs: [{
            orderable: false,
            className: 'select-checkbox',
            targets: 0
        }],
        select: {
            style: 'multi',  // 确保多选模式
            selector: 'td:first-child'
        },
        pageLength: 5,
        order: [[1, 'asc']],
        createdRow: function (row, data, dataIndex) {
            // 检查当前行是否为Error状态
            const parser = new DOMParser();
            const parsedDoc = parser.parseFromString(data[6], 'text/html');
            const optimizationStatus = parsedDoc.body.textContent.trim();

            if (optimizationStatus === 'Error') {
                // 移除select-checkbox类，清空该单元格
                $('td:eq(0)', row).removeClass('select-checkbox').empty();
            }
        }
    });
    // 使用 user-select 事件在用户尝试选择行时拦截
    table.on('user-select', function (e, dt, type, cell, originalEvent) {
        // 确保事件是由选择行触发的
        if (type === 'row') {
            // 获取当前行数据
            const rowData = dt.row(cell.index().row).data();
            // rowData是一个数组，对应表格列的数据顺序
            // 根据你的表格定义，Optimization Status位于列索引6
            const parser = new DOMParser();
            const parsedDoc = parser.parseFromString(rowData[6], 'text/html');
            const optimizationStatus = parsedDoc.body.textContent.trim();

            // 如果状态为Error，则阻止该行被选中
            if (optimizationStatus === 'Error') {
                e.preventDefault();
            }
        }
    });
    // 将DataTable中所有行及其gene-id保存起来，以便后续筛选使用
    const allRows = [];
    table.rows().every(function (rowIdx, tableLoop, rowLoop) {
        const rowNode = this.node();
        const geneId = $(rowNode).data('gene-id');
        const rowData = this.data(); // 每行的表格数据（数组格式）
        allRows.push({ geneId: geneId, data: rowData });
    });

    // 当点击 Codon Optimization 按钮时，根据选择情况动态展示
    document.getElementById('codonOptimizeButton').addEventListener('click', function () {
        const selectedGeneIds = $('input.gene-checkbox:checked').map(function () {
            return $(this).val();
        }).get();

        table.clear();  // 清空原有数据

        let rowsToAdd;
        if (selectedGeneIds.length === 0) {
            // 未选中任何基因时：显示所有
            rowsToAdd = allRows; 
        } else {
            // 已选中部分基因时：只显示选中基因
            rowsToAdd = allRows.filter(r => selectedGeneIds.includes(String(r.geneId)));
        }

        // 按行添加，并为每个添加的行增加 data-gene-id 属性
        rowsToAdd.forEach(r => {
            const rowNode = table.row.add(r.data).draw(false).node();
            $(rowNode).attr('data-gene-id', r.geneId);
        });

        table.draw();
    });

    // 表单提交逻辑
    $('#bulkOptimizationForm').on('submit', function (event) {
        event.preventDefault();

        // 从DataTables获取当前显示（过滤后）的行节点
        // 获取选中的基因 ID
        var selectedGenes = $('#gene-table-datatable').DataTable().rows({ selected: true }).nodes().to$().map(function() {
            return $(this).data('gene-id');
        }).get();
        console.log('Selected genes:', selectedGenes);

        if (selectedGenes.length === 0) {
            alert('Please select at least one gene.');
            return;
        }

        // 验证物种选择
        const selectedSpecies = $('#speciesSelect').val();
        if (!selectedSpecies) {
            alert('Please choose a species.');
            return;
        }

        // 验证优化方法选择
        const selectedMethod = $('input[name="optimization_method"]:checked').val();
        if (!selectedMethod) {
            alert('Please select an optimization method.');
            return;
        }

        // 设置隐藏字段
        $('#selectedGenes').val(selectedGenes.join(','));
        console.log('Selected genes:', selectedGenes);

        // 动态添加优化方法字段
        $('<input>').attr({
            type: 'hidden',
            name: 'optimization_method',
            value: selectedMethod
        }).appendTo(this);

        // 动态添加物种字段
        $('<input>').attr({
            type: 'hidden',
            name: 'species_select_for_optimization',
            value: selectedSpecies
        }).appendTo(this);

        // 提交表单
        this.submit();
    });
});

</script>
{% endblock %}