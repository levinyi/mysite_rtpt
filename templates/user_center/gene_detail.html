{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Edit sequences{% endblock %}
{% block extra_head %}
<style>
    .small-dropdown-menu {
        --bs-dropdown-min-width:10px;
        --bs-dropdown-padding-y:0px;
    }
    .small-dropdown-item {
        padding:4px;
    }
    .small-dropdown-item:hover {
      background-color: rgba(5, 109, 232, 0.1);
    }
    .codon {
        border: 1px dashed black;
        display: inline-block;
        margin-right: -1px;
    }
    .fixed-right {
        position: fixed;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        background-color: #f0f0f0; /* 调整背景颜色 */
        border-radius: 10px 0 0 10px; /* 半圆形的边缘 */
    }
    .action-inner {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
    }
    .bi-exclamation-circle {
        font-size: 2rem;
        color: #dc3545;
    }
    .action-text {
        font-size: 0.8rem;
        color: #dc3545;
    }
    .fixed-right:hover {
        background-color: #e0e0e0;
        cursor: pointer;
    }
</style>
{% endblock %}
{% block content %}
<!-- 悬浮的竖条，用于触发Offcanvas -->
<div class="fixed-right" data-bs-toggle="offcanvas" data-bs-target="#offcanvasWithBothOptions" aria-controls="offcanvasWithBothOptions">
    <div class="action-inner">
        <i class="bi bi-exclamation-circle"></i>
        <div class="action-text">WARNING</div>
    </div>
</div>

<!-- Offcanvas -->
<div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasWithBothOptions" aria-labelledby="offcanvasWithBothOptionsLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasWithBothOptionsLabel">Prohibition and Risk</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <!-- Tier 1 Warning -->
        <h4 class="bg-secondary text-white p-2">Tier 1 Warning:</h4>
        <p class="p-2"><span class="bg-danger text-white">Red color</span> highlighted sequences are <span class="text-danger">NOT</span> allowed for synthesis. Ordering will not proceed until approved by our SequenceAnalyzer.</p>
        <ul>
            <li>Overall GC% across the entire sequence is &le; 20% or &ge; 80%.</li>
            <li>Presence of forbidden sequences in the inquiry form.</li>
        </ul>
        <!-- Tier 2 Warning -->
        <h4 class="bg-secondary text-white p-2">Tier 2 Warning:</h4>
        <p class="p-2"><span class="bg-warning text-dark">Yellow color</span> highlighted sequences are <span class="text-warning">AT RISK</span> for synthesis. Modifications are recommended.</p>
        <p>We understand some sequences may not be editable. In this case, ordering can proceed, but it may affect the gene's success rate.</p>
        <ul>
            <li>Overall GC% across the entire sequence is within (20%, 30%] or [70%, 80%).</li>
            <li>Extremely high local GC content.</li>
            <li>Presence of long consecutive A/T/G/C.</li>
        </ul>
    </div>
</div>


<div class="container-fluid" style="padding-left:50px;">
    <div class="row mt-3">
        <h2>Editing Gene Sequences</h2>
        {% for gene in gene_list %}
        <!-- First Row -->
        <div class="row mt-5">
            <div class="col-4">
                <p> Gene Name: {{ gene.gene_name }}</p>
                <p> Overall GC content: {{ gene.gc_content|floatformat:2 }}%</p>
            </div>
            <div class="col-6">
                <p>Forbidden check list <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" 
                title="The listed sequences are avoided by default to assist subsequent cloning process"></i> : {{ gene.forbidden_check_list }}. </p>
                <p> And found : {{ gene.contained_forbidden_list }}</p>
            </div>
        </div>
        <!-- Second Row -->
        <div class="row mb-5 mt-3">
            <!-- First Column -->
            <div class="col-md-5 col-12">
                <p class="monospace-text">Original sequences <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="A 20 bp upstream vector sequence and a 20 bp downstream vector sequence are shown in grey. This only provides a view for insertion site, which is not counted for charging"></i> :</p>
                <!-- Add your sequences content here -->
                <div class="card">
                    <div {% if gene.status == 'saved' %} class="card-body text-truncate" {% else %} class="card-body monospace-text" {% endif %} id="sequence">{{ gene.combined_seq|safe}}</div>
                </div>
            </div>
            <!-- Second Column -->
            <div class="col-md-5 col-12">
                <p class="monospace-text">Edited sequences <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="A 20 bp upstream vector sequence and a 20 bp downstream vector sequence are shown in grey. This only provides a view for insertion site, which is not counted for charging"></i> :</p>
                <div class="card">
                    <div {% if gene.status == 'saved' %} class="card-body text-truncate" contenteditable="false"{% else %} class="card-body monospace-text" contenteditable="true" {% endif %} id="edited_sequence">{{ gene.saved_seq|safe }}</div>
                </div>
            </div>
            <!-- Third Column -->
            <div class="col-md-2 col-12">
                {% if gene.status != "saved" %}
                    <p>Choose Species:</p>
                    <div style="max-width:182px;">
                        <select class="form-select" aria-label="Default select example">
                        </select>
                    </div>
                {% endif %}

                <div class="mt-3">
                    {% if gene.status != 'saved' %}
                    <label for="frameshiftSelector">Choose frameshift:</label>
                    <select id="frameshiftSelector">
                        <option value="0" selected>0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                    <button class="btn btn-warning toggle-btn mt-3">Toggle Codon Boxes</button>
                    <button class="btn btn-primary mt-3 analysis-btn" data-gene-name="{{ gene.gene_name }}">Re-analyze</button>
                    {% endif %}

                    {% if gene.status == "saved" %}
                        <button class="btn btn-primary mt-4" style="width:100px;" id="editButton" data-url="{% url 'user_center:gene_edit' gene.id %}">Edit</button>
                    {% elif gene.status == "validated" %}
                        <button class="btn btn-success mt-3" id="saveButton" data-url="{% url 'user_center:validation_save' gene.id %}">Save</button>
                    {% else %}
                        <button class="btn btn-secondary mt-3" disabled>Save</button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="row">
        <div class="col text-center mb-5">
            <!-- 如果全部status为saved，则显示order now按钮 -->
            {% comment %} {% if gene_list|check_status:"saved" %} {% endcomment %}
            <a href="{% url 'user_center:order_create' %}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Add more Genes</a>
            <a href="{% url 'user_center:view_cart' %}" class="btn btn-primary"><i class="bi bi-cart3"></i> Go to Shopping Cart</a>
            {% comment %} {% endif %} {% endcomment %}
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script src="{% static 'species/amino_acid_data.js' %}"></script>
<script src="{% static 'species/species_data.js' %}"></script>
<script>

    function clickNewCodon(e, event) {
        // 替换codon
        console.log(e);
        e.setAttribute("aria-current", "true");
        console.log(e);
        e.parentElement.parentElement.parentElement.childNodes[0].innerText = e.innerText;
    }

    // 点击Toggle Codon Boxes按钮时，显示或隐藏codon框
    document.addEventListener("DOMContentLoaded", function() {
        // 默认从species_data.json中获取全部物种名称
        function get_specie_names() {
            var specie_names = Object.keys(species);
            return specie_names;
        }
        
        const specie_names = get_specie_names();
        const specieSelector = $('.form-select');
        // 遍历specie_names，添加到specieSelector中
        specie_names.forEach(function(specie_name) {
            specieSelector.append(`<option value="${specie_name}">${specie_name}</option>`);
        });


        function getCodonDetail(specie_name, codon) {
            if(species[specie_name].hasOwnProperty(codon)) {
                const acid = species[specie_name][codon]["Amino acid"];
                if(aminoAcid[specie_name].hasOwnProperty(acid)) {
                    list = aminoAcid[specie_name][acid];
                    return list;
                }
            }
            return null;
        }
        
        // 添加事件监听器
        function addCodonBoxEventListeners(codonBox, selector) {
            codonBox.addEventListener("click", function(e, event) {
                const codon = codonBox.childNodes[0].textContent;
                const list = getCodonDetail(selector.value, codon);
                const item_begin = `<li><a class="dropdown-item small-dropdown-item" onclick="clickNewCodon(this,event)">`;
                const item_end = `</a></li>`;
                var ul = codonBox.querySelector("ul");
                ul.innerHTML = ""
                if(list.length > 0) {
                    console.log(list.length);
                    for (let i = 0; i < list.length; i++) {
                        // 追加列表元素
                        ul.innerHTML += (item_begin + list[i]["Triplet"] + item_end)
                    }
                }
            });
            codonBox.addEventListener("mouseenter", function(e, event) {
                const codon = e.srcElement.innerText;
                const list = getCodonDetail(selector.value, codon);
                if (list === null) {
                    codonBox.setAttribute('title', "Unknown");
                }
                else{
                    // var text = 'Triplet(' + list[0]["Amino acid"] + ')   Frequency  Fraction \n'
                    var text = ' \t\t  ' + list[0]["Amino acid"] + ' \t   Frequency  Fraction \n'
                    list.forEach(function(item) {
                        var fre = item["Frequency"].toFixed(2).padEnd(9, ' ');
                        var fra = item["Fraction"].toFixed(2).padEnd(9, ' ');
                        // 尽量对齐，不足加空格
                        text += ('  ' + item["Triplet"] + " :").padEnd(13, ' ') + "  " + fre + "\t" + fra + '\n';
                    });
                    codonBox.setAttribute('title', text);
                }
            });
        }

        function displayCodonBoxes(editedSequenceDiv, shift, originalSeqContent) {
            let currentIndex = 0;
            let wrappedSeq = '';
            // 使用DOM解析器处理原始内容
            const tempDiv = document.createElement('div')
            tempDiv.innerHTML = originalSeqContent;

            // 递归函数来遍历节点并正确添加密码子框
            function processNode(node, index, length) {
                const begin = `<span class="codon"><span data-bs-toggle="dropdown">`;
                const end = `</span><ul class="dropdown-menu small-dropdown-menu"></ul></span></span>`;
                var len = node.nodeType === Node.TEXT_NODE? node.textContent.length : node.childNodes.length;
                    // 处理文本节点
                for (let i = 0; i < len; i++) {
                    var content;
                    if(node.nodeType === Node.TEXT_NODE){
                        if(!/[a-zA-Z]/.test(node.textContent[i])) continue;
                        content = node.textContent[i];
                    }
                    else{
                        if(!/[a-zA-Z]/.test(node.childNodes[i].innerText)) continue;
                        // if(currentIndex < 20)
                        //    node.childNodes[i].innerText = node.childNodes[i].innerText.toLowerCase();
                        content = node.childNodes[i].outerHTML;
                    }
                    // 跳过非字母节点
                    if ((currentIndex - shift) % 3 === 0) {
                        wrappedSeq += begin;
                    }

                    wrappedSeq += content;
                                            
                    if ((currentIndex - shift + 1) % 3 === 0) {
                        wrappedSeq += end;
                    }
                    currentIndex++;
                }
            }
            var len = tempDiv.childNodes.length;
            tempDiv.childNodes.forEach((child,index) => processNode(child,index,len));
            editedSequenceDiv.innerHTML = wrappedSeq;

            document.querySelectorAll(".codon").forEach(function(codonBox, index) {
                var selector = codonBox.closest('.col-md-5').nextElementSibling.querySelector(".form-select");
                // 添加事件监听器
                addCodonBoxEventListeners(codonBox, selector);

            });
        }

        const toggleButtons = document.querySelectorAll(".toggle-btn");
        const selectors = document.querySelectorAll(".form-select");
        // 为每个selector添加事件监听器


        // 为每个Toggle Codon Boxes按钮添加事件监听器
        toggleButtons.forEach(function(toggleButton) {
            const editedSequenceDiv = toggleButton.closest('.col-md-2').previousElementSibling.querySelector("#edited_sequence");
            console.log(editedSequenceDiv);
            const frameshiftSelector = toggleButton.closest('.col-md-2').querySelector("#frameshiftSelector");

            let isCodonDisplayed = false;
            const originalSeqContent = editedSequenceDiv.innerHTML;

            frameshiftSelector.addEventListener("change", function() {
                if (isCodonDisplayed) {
                    displayCodonBoxes(editedSequenceDiv, parseInt(frameshiftSelector.value), originalSeqContent);
                }
            });

            toggleButton.addEventListener("click", function() {
                if (isCodonDisplayed) {
                    // 隐藏codon框
                    editedSequenceDiv.innerHTML = originalSeqContent;
                    isCodonDisplayed = false;
                } else {
                    // 显示codon框
                    displayCodonBoxes(editedSequenceDiv, parseInt(frameshiftSelector.value), originalSeqContent);
                    isCodonDisplayed = true;
                }
            });
        });

    });

</script>
<script>
    // 点击Re-analyze按钮时，发送请求
    document.addEventListener("DOMContentLoaded", function() {
        const analysisButtons = document.querySelectorAll(".analysis-btn"); 

        analysisButtons.forEach(function(analysisButton) {
            analysisButton.addEventListener("click", function() {
                const editedSequenceDiv = analysisButton.closest('.col-md-2').previousElementSibling.querySelector(".card-body");
                const geneName = analysisButton.getAttribute("data-gene-name");

                // 获取editedSequenceDiv的内容和geneName
                const sequenceContent = editedSequenceDiv.innerText;
        
                // 构建要发送的数据
                const data = {
                    sequence: sequenceContent,
                    gene: geneName,
                };
                console.log("data: ", data);
                // 创建一个新的XMLHttpRequest对象
                const xhr = new XMLHttpRequest();

                xhr.open('POST', `/user_center/gene_validation/`, true);

                // 设置请求头，以便服务器知道我们发送的是JSON数据
                xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                // 设置回调函数，处理响应数据
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        const response = JSON.parse(xhr.responseText);
                        console.log(response);
                        // 你可以在这里加入处理响应数据的代码
                        if(response.status === 'success') {
                            // 弹窗提示
                            alert('Re-analyzed!');
                            location.reload();
                        } else if (response.status === 'error') {
                            alert(response.message);
                        }
                    };
                };

                // 发送请求
                xhr.send(JSON.stringify(data));
            });
        });
    });
</script>
<script>
// for save button
$(document).ready(function() {
    $('#saveButton').on('click', function(e, event) {
        const url = $(this).data('url');
        console.log(e.target);
        const editedSequenceDiv = e.target.closest('.col-md-2').previousElementSibling.querySelector(".card-body");

        // 获取editedSequenceDiv的内容和geneName
        const sequenceContent = editedSequenceDiv.innerText;
        
        // 构建要发送的数据
        $.ajax({
            url: url,
            type: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            data:JSON.stringify({
                sequence: sequenceContent,
            }),
            success: function(response) {
                if(response.status === 'success') {
                    // alert(response.message); // 或其他方式显示成功消息
                    location.reload();
                } else {
                    console.log(response);
                    alert(response.message); // 或其他方式显示错误消息
                }
            },
            error: function() {
                alert('请求失败'); // 或其他方式显示错误消息
            }
        });
    });
});
// for edit button
$(document).ready(function() {
    $('#editButton').on('click', function() {
        const url = $(this).data('url');

        $.ajax({
            url: url,
            type: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function(response) {
                if(response.status === 'success') {
                    // alert(response.message); // 或其他方式显示成功消息
                    location.reload();
                } else {
                    alert(response.message); // 或其他方式显示错误消息
                }
            },
            error: function() {
                alert('请求失败'); // 或其他方式显示错误消息
            }
        });
    });
});
</script>
<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>
{% endblock %}

