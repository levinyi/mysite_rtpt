{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Edit sequences{% endblock %}
{% block extra_head %}
<style>
    .codon {
        border: 1px dashed black;
        display: inline-block;
        margin-right: -1px;
    }
    .fixed-right {
        position: fixed;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        background-color: #f0f0f0; /* 调整背景颜色 */
        border-radius: 10px 0 0 10px; /* 半圆形的边缘 */
    }
    .action-inner {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
    }
    .bi-exclamation-circle {
        font-size: 2rem;
        color: #dc3545;
    }
    .action-text {
        font-size: 0.8rem;
        color: #dc3545;
    }
    .fixed-right:hover {
        background-color: #e0e0e0;
        cursor: pointer;
    }
</style>
{% endblock %}
{% block content %}
<!-- 悬浮的竖条，用于触发Offcanvas -->
<div class="fixed-right" data-bs-toggle="offcanvas" data-bs-target="#offcanvasWithBothOptions" aria-controls="offcanvasWithBothOptions">
    <div class="action-inner">
        <i class="bi bi-exclamation-circle"></i>
        <div class="action-text">Cautions</div>
    </div>
</div>

<!-- Offcanvas -->
<div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasWithBothOptions" aria-labelledby="offcanvasWithBothOptionsLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasWithBothOptionsLabel">Prohibition and Risk</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <!-- Tier 1 Warning -->
        <h4 class="bg-secondary text-white p-2">Tier 1 Warning:</h4>
        <p class="p-2"><span class="bg-danger text-white">Red color</span> highlighted sequences are <span class="text-danger">NOT</span> allowed for synthesis. Ordering will not proceed until approved by our SequenceAnalyzer.</p>
        <ul>
            <li>Overall GC% across the entire sequence is &le; 20% or &ge; 80%.</li>
            <li>Presence of forbidden sequences in the inquiry form.</li>
        </ul>
        <!-- Tier 2 Warning -->
        <h4 class="bg-secondary text-white p-2">Tier 2 Warning:</h4>
        <p class="p-2"><span class="bg-warning text-dark">Yellow color</span> highlighted sequences are <span class="text-warning">AT RISK</span> for synthesis. Modifications are recommended.</p>
        <p>We understand some sequences may not be editable. In this case, ordering can proceed, but it may affect the gene's success rate.</p>
        <ul>
            <li>Overall GC% across the entire sequence is within (20%, 30%] or [70%, 80%).</li>
            <li>Extremely high local GC content.</li>
            <li>Presence of long consecutive A/T/G/C.</li>
        </ul>
    </div>
</div>

<div class="container-fluid" style="padding-left:50px;">
    <div class="row mt-3">
        <h2>Editing Gene Sequences</h2>
        {% for gene in gene_list %}
        <!-- First Row -->
        <div class="row mt-5">
            <div class="col-4">
                <p> Gene Name: {{ gene.gene_name }}</p>
                <p> Overall GC content: {{ gene.gc_content|floatformat:2 }}%</p>
            </div>
            <div class="col-6">
                <p>Forbidden check list <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="The underlined sequences are avoided by default to assist subsequent cloning process"></i> : {{ gene.forbidden_check_list }}. </p>
                <p> And found : {{ gene.contained_forbidden_list }}</p>
            </div>
        </div>
        <!-- Second Row -->
        <div class="row mb-5 mt-3">
            <!-- First Column -->
            <div class="col-md-5 col-12">
                <p class="monospace-text">Original sequences <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Up- & Down-stream 20 bp regions of the insertion site are appended at 5' and 3' ends, shown in lowercase letters."></i> :</p>
                <!-- Add your sequences content here -->
                <div class="card">
                    <div {% if gene.status == 'saved' %} class="card-body text-truncate" {% else %} class="card-body monospace-text" {% endif %} id="sequence">{{ gene.combined_seq|safe}}</div>
                </div>
            </div>
            <!-- Second Column -->
            <div class="col-md-5 col-12">
                <p class="monospace-text">Edited sequences <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Up- & Down-stream 20 bp regions of the insertion site are appended at 5' and 3' ends, shown in capital letters."></i> :</p>
                <div class="card">
                    <div {% if gene.status == 'saved' %} class="card-body text-truncate" contenteditable="false"{% else %} class="card-body monospace-text" contenteditable="true" {% endif %} id="edited_sequence">{{ gene.saved_seq|safe }}</div>
                </div>
            </div>
            <!-- Third Column -->
            <div class="col-md-2 col-12">
                {% if gene.status != "saved" %}
                    <p>Codons shown in boxes:</p>
                {% endif %}
                <div class="mt-3">
                    {% if gene.status == 'forbidden' or gene.status == 'validated' %}
                    <label for="frameshiftSelector">Choose frameshift:</label>
                    <select id="frameshiftSelector">
                        <option value="0" selected>0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                    <button class="btn btn-warning toggle-btn mt-3">Toggle Codon Boxes</button>
                    <button class="btn btn-primary mt-3 analysis-btn" data-gene-name="{{ gene.gene_name }}">Re-analyze</button>
                    {% endif %}

                    {% if gene.status == 'forbidden' %}
                        <button class="btn btn-secondary mt-3" disabled>UnSaved</button>
                    {% elif gene.status == "saved" %}
                        <button class="btn btn-primary mt-4" style="width:100px;" id="editButton" data-url="{% url 'user_center:gene_edit' gene.id %}">Edit</button>
                    {% elif gene.status == "validated" %}
                        <button class="btn btn-success mt-3" id="saveButton" data-url="{% url 'user_center:validation_save' gene.id %}">Save</button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="row">
        <div class="col text-center mb-5">
            <!-- 如果全部status为saved，则显示order now按钮 -->
            {% comment %} {% if gene_list|check_status:"saved" %} {% endcomment %}
            <a href="{% url 'user_center:order_create' %}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Add more Genes</a>
            <a href="{% url 'user_center:view_cart' %}" class="btn btn-primary"><i class="bi bi-cart3"></i> Go to Shopping Cart</a>
            {% comment %} {% endif %} {% endcomment %}
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    // 点击Toggle Codon Boxes按钮时，显示或隐藏codon框
    document.addEventListener("DOMContentLoaded", function() {
        const toggleButtons = document.querySelectorAll(".toggle-btn");
        const codonFrequency = {
            'AAA': 'Lysine (K) - 24%',
            'GCC': 'Alanine (A) - 18%',
            'GGC': 'Glycine (G) - 18%',
            'GAC': 'Aspartic acid (D) - 18%',
            'GTC': 'Valine (V) - 18%',
            'TTC': 'Phenylalanine (F) - 18%',
            'TAC': 'Tyrosine (Y) - 18%',
            'TCC': 'Serine (S) - 18%',
            'TGC': 'Cysteine (C) - 18%',
            'TCT': 'Serine (S) - 18%',
            'TAT': 'Tyrosine (Y) - 18%',
            'TGT': 'Cysteine (C) - 18%',
            'TGG': 'Tryptophan (W) - 18%',
            'CTC': 'Leucine (L) - 18%',
            'CTG': 'Leucine (L) - 18%',
            'CTT': 'Leucine (L) - 18%',
            'CTA': 'Leucine (L) - 18%',
            'CAC': 'Histidine (H) - 18%',
            'CAT': 'Histidine (H) - 18%',
            'CAA': 'Glutamine (Q) - 18%',
            'CAG': 'Glutamine (Q) - 18%',
            'CGC': 'Arginine (R) - 18%',
            'CGG': 'Arginine (R) - 18%',
            'CGT': 'Arginine (R) - 18%',
            'CGA': 'Arginine (R) - 18%',
            'ATC': 'Isoleucine (I) - 18%',
            'ATT': 'Isoleucine (I) - 18%',
            'ATA': 'Isoleucine (I) - 18%',
            'AAC': 'Asparagine (N) - 18%',
            'AAT': 'Asparagine (N) - 18%',
            'AGC': 'Serine (S) - 18%',
            'AGT': 'Serine (S) - 18%',
        }

        // 添加事件监听器
        function addCodonBoxEventListeners() {
            document.querySelectorAll(".codon").forEach(function(codonBox, index) {
                // console.log("Adding event listener to codon box", index); // 确认这个函数被调用

                codonBox.addEventListener("mouseenter", function() {
                    const codon = codonBox.textContent;
                    const frequencyInfo = codonFrequency[codon] || "Unknown";
                    codonBox.setAttribute('title', frequencyInfo);
                });
            });
        }


        // 为每个Toggle Codon Boxes按钮添加事件监听器
        toggleButtons.forEach(function(toggleButton) {
            const editedSequenceDiv = toggleButton.closest('.col-md-2').previousElementSibling.querySelector("#edited_sequence");
            const frameshiftSelector = toggleButton.closest('.col-md-2').querySelector("#frameshiftSelector");

            let isCodonDisplayed = false;
            const originalSeqContent = editedSequenceDiv.innerHTML;

            function displayCodonBoxes() {
                const frameshift = parseInt(frameshiftSelector.value, 10);
                let currentIndex = 0;
                let wrappedSeq = '';

                // 使用DOM解析器处理原始内容
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = originalSeqContent;

                // 递归函数来遍历节点并正确添加密码子框
                function processNode(node) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        // 处理文本节点
                        for (let i = 0; i < node.textContent.length; i++) {
                            if ((currentIndex - frameshift) % 3 === 0) {
                                wrappedSeq += '<span class="codon">';
                            }

                            wrappedSeq += node.textContent[i];

                            if ((currentIndex - frameshift + 1) % 3 === 0) {
                                wrappedSeq += '</span>';
                            }
                            currentIndex++;
                        }
                    } else if (node.nodeType === Node.ELEMENT_NODE) {
                        // 处理元素节点
                        wrappedSeq += `<${node.tagName.toLowerCase()} class="${node.className}">`;
                        node.childNodes.forEach(child => processNode(child));
                        wrappedSeq += `</${node.tagName.toLowerCase()}>`;
                    }
                }

                tempDiv.childNodes.forEach(child => processNode(child));

                editedSequenceDiv.innerHTML = wrappedSeq;
                isCodonDisplayed = true;

                // 添加事件监听器
                addCodonBoxEventListeners();
            }

            frameshiftSelector.addEventListener("change", function() {
                if (isCodonDisplayed) {
                    displayCodonBoxes();
                }
            });

            toggleButton.addEventListener("click", function() {
                if (isCodonDisplayed) {
                    // 隐藏codon框
                    editedSequenceDiv.innerHTML = originalSeqContent;
                    isCodonDisplayed = false;
                } else {
                    // 显示codon框
                    displayCodonBoxes();
                    isCodonDisplayed = true;
                }
            });
        });

    });


</script>
<script>
    // 点击Re-analyze按钮时，发送请求
    document.addEventListener("DOMContentLoaded", function() {
        const analysisButtons = document.querySelectorAll(".analysis-btn"); 

        analysisButtons.forEach(function(analysisButton) {
            analysisButton.addEventListener("click", function() {
                const editedSequenceDiv = analysisButton.closest('.col-md-2').previousElementSibling.querySelector(".card-body");
                const geneName = analysisButton.getAttribute("data-gene-name");

                // 获取editedSequenceDiv的内容和geneName
                const sequenceContent = editedSequenceDiv.innerText;
        
                // 构建要发送的数据
                const data = {
                    sequence: sequenceContent,
                    gene: geneName,
                };
                console.log("data: ", data);
                // 创建一个新的XMLHttpRequest对象
                const xhr = new XMLHttpRequest();

                xhr.open('POST', `/user_center/gene_validation/`, true);

                // 设置请求头，以便服务器知道我们发送的是JSON数据
                xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                // 设置回调函数，处理响应数据
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        const response = JSON.parse(xhr.responseText);
                        console.log(response);
                        // 你可以在这里加入处理响应数据的代码
                        if(response.status === 'success') {
                            // 弹窗提示
                            alert('Re-analyzed!');
                            location.reload();
                        } else if (response.status === 'error') {
                            alert(response.message);
                        }
                    };
                };

                // 发送请求
                xhr.send(JSON.stringify(data));
            });
        });
    });
</script>
<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>
<script>
// for save button
$(document).ready(function() {
    $('#saveButton').on('click', function() {
        const url = $(this).data('url');

        $.ajax({
            url: url,
            type: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function(response) {
                if(response.status === 'success') {
                    // alert(response.message); // 或其他方式显示成功消息
                    location.reload();
                } else {
                    alert(response.message); // 或其他方式显示错误消息
                }
            },
            error: function() {
                alert('请求失败'); // 或其他方式显示错误消息
            }
        });
    });
});
</script>
<script>
// for edit button
$(document).ready(function() {
    $('#editButton').on('click', function() {
        const url = $(this).data('url');

        $.ajax({
            url: url,
            type: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function(response) {
                if(response.status === 'success') {
                    // alert(response.message); // 或其他方式显示成功消息
                    location.reload();
                } else {
                    alert(response.message); // 或其他方式显示错误消息
                }
            },
            error: function() {
                alert('请求失败'); // 或其他方式显示错误消息
            }
        });
    });
});
</script>
{% endblock %}

