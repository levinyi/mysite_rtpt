{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Edit sequences{% endblock %}
{% block extra_head %}
    <style>
        .small-dropdown-menu {
            --bs-dropdown-min-width:10px;
            --bs-dropdown-padding-y:0px;
        }
        .small-dropdown-item {
            padding:4px;
        }
        .small-dropdown-item:hover {
        background-color: rgba(5, 109, 232, 0.1);
        }
        .codon {
            border: 1px dashed black;
            display: inline-block;
            margin-right: -1px;
        }
        .fixed-right {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background-color: #f0f0f0; /* 调整背景颜色 */
            border-radius: 10px 0 0 10px; /* 半圆形的边缘 */
        }
        .action-inner {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }
        .bi-exclamation-circle {
            font-size: 2rem;
            color: #dc3545;
        }
        .action-text {
            font-size: 0.8rem;
            color: #dc3545;
        }
        .fixed-right:hover {
            background-color: #e0e0e0;
            cursor: pointer;
        }
        .danger { background-color: red; }
        .warning { background-color: yellow; }
        .row {
            display: flex;
            flex-wrap: wrap;
        }
        .col-md-3 {
            display: flex;
        }
        .card {
            flex: 1;
        }
    </style>
{% endblock %}
{% block content %}

<!-- Modal for bulk optimization settings -->
<div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" id="bulkOptimizationModal" tabindex="-1" aria-labelledby="bulkOptimizationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkOptimizationModalLabel">Bulk Optimization Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Get failed gene information -->
                <h5 class="text-center">Select Genes that you want to optimize</h5>
                <table id="gene-table-datatable" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th></th> <!-- For Select Checkboxes -->
                            <th>#</th>
                            <th>GeneName</th>
                            <th>Vector</th>
                            <th>Status</th>
                            <th>Length</th>
                            <th>GC%</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for gene in gene_list %}
                        <tr data-gene-id="{{ gene.id }}"> <!-- Use data attribute to store gene ID -->
                            <td></td> <!-- DataTables will render checkboxes here -->
                            <td>{{ forloop.counter }}</td>
                            <td>{{ gene.gene_name }}</td>
                            <td>{{ gene.vector.vector_id }}</td>
                            <td>
                                {% if gene.status == 'forbidden' %}
                                    <span class="badge bg-danger">Forbidden</span>
                                {% elif gene.status == 'validated' %}
                                    <span class="badge bg-success text-dark">Validated</span>
                                {% else %}
                                    <span class="badge bg-info">Saved</span>
                                {% endif %}
                            </td>
                            <td>{{ gene.original_seq|length }}</td>
                            <td>{{ gene.original_gc_content|floatformat }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>

                <!-- Form for submitting selected genes -->
                <form id="bulkOptimizationForm" action="{% url 'user_center:bulk_optimization_submit' %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="speciesSelect" class="form-label">Choose a species for All Selected genes.</label>
                        <select class="form-select" id="speciesSelect" name="species_select">
                            <option value="" selected>Choose a species</option>
                            {% for species in species_names %}
                                <option value="{{ species }}">{{ species }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <input type="hidden" id="selectedGenes" name="selected_genes">
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Toasts for warnings centered -->
<div class="position-fixed top-50 start-50 translate-middle toast-container" style="z-index: 1055;">
    <div id="geneToast" class="toast align-items-center text-bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Please select at least one gene to optimize.
            </div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    <div id="speciesToast" class="toast align-items-center text-bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Please select a species.
            </div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Main Page -->
<div class="container-fluid" style="padding-left:50px;padding-right:50px;">
    <!-- Breadcrumb -->
    <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb" class="mt-2">
        <div class="d-flex justify-content-between align-items-center">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'user_center:dashboard' %}" class="text-decoration-none">User Center</a></li>
                <li class="breadcrumb-item"><a href="{% url 'user_center:view_cart' %}" class="text-decoration-none">Shopping Cart</a></li>
                <li class="breadcrumb-item active" aria-current="page">Gene Details</li>
            </ol>
        </div>
    </nav>
    <!-- Gene Information -->
    <div class="card mt-3" style="background-color: #f0f0f0;">
        <div class="container">
            <div class="row mt-4">
                <!-- Spinner -->
                <div id="loadingSpinner" class="text-center mb-4" style="display: none;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <!-- Total Genes Card -->
                <div class="col-md-3 mb-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">{{ gene_list.count }} Total Genes</h5>
                            <canvas id="geneClassificationChart" width="100" height="100"></canvas>
                        </div>
                    </div>
                </div>
                <!-- GC Content Distribution Card -->
                <div class="col-md-3 mb-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">GC Content Distribution</h5>
                            <canvas id="gcContentChart" width="100" height="100"></canvas>
                        </div>
                    </div>
                </div>
                <!-- Gene Length Distribution Card -->
                <div class="col-md-3 mb-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Gene Length Distribution</h5>
                            <canvas id="geneLengthChart" width="100" height="100"></canvas>
                        </div>
                    </div>
                </div>
                <!-- Sequence Complexity Card -->
                <div class="col-md-3 mb-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Sequence Penalty</h5>
                            <canvas id="sequenceComplexityChart" width="100" height="100"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Gene List -->
    <div class="row mt-3">
        {% for gene in gene_list %}
        <div class="accordion mb-3" id="accordion{{ forloop.counter }}">
            <div class="card accordion-item">
                <div class="accordion-header" id="heading{{ forloop.counter }}">
                    <button class="accordion-button text-white  
                        {% if gene.status == 'forbidden' %} bg-danger {% elif gene.penalty_score > 50 %} bg-warning {% else %} bg-success {% endif %}" 
                    type="button" 
                    data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false" aria-controls="collapse{{ forloop.counter }}">
                        <div class="col-4 text-start">
                            {{ forloop.counter }}. Item Name: {{ gene.gene_name }} 
                        </div>
                        <div class="col-6">
                            Found Forbidden Sequence: {{ gene.contained_forbidden_list }}
                        </div>
                        <div class="col-2 text-end" data-bs-toggle="tooltip" data-bs-placement="right" title="green: score <10; yellow:10<score<30; red:score>30">
                            {% if gene.penalty_score %}
                                Total Penalty Score: {{ gene.penalty_score }}
                            {% else %}
                                Total Penalty Score: NOT APPLY
                            {% endif %}
                        </div>
                    </button>
                </div>
                <div id="collapse{{ forloop.counter }}" class="accordion-collapse" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#accordion{{ forloop.counter }}">
                    <div class="card-body">
                        <!-- Sequence box -->
                        <div class="row">
                            <!-- First Column Original sequences -->
                            <div class="col-md-5 col-12">
                                <p class="monospace-text">Original sequences <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" 
                                    title="A 20 bp upstream vector sequence and a 20 bp downstream vector sequence are shown in grey. 
                                    This only provides a view for insertion site, which is not counted for charging"></i> : Length {{gene.original_seq|length}} bp. Overall GC content {{ gene.original_gc_content|floatformat }}%</p>
                                <!-- sequences content here -->
                                <div class="card">
                                    <div {% if gene.status != 'saved' %} style="display:none" {% endif %} class="card-body text-truncate first_col_trun" id="sequence-truncate">
                                        {{ gene.original_seq|highlight_sequence_with_offset:gene.original_highlights|safe }}
                                    </div>
                                    <div {% if gene.status == 'saved' %} style="display:none" {% endif %} class="card-body monospace-text first_col_full" id="sequence">
                                        {{ gene.original_seq|highlight_sequence_with_offset:gene.original_highlights|safe }}
                                    </div>
                                </div>
                            </div>
                            <!-- Second Column Edited sequences -->
                            <div class="col-md-5 col-12">
                                <p class="monospace-text">Edited sequences <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" 
                                    title="A 20 bp upstream vector sequence and a 20 bp downstream vector sequence are shown in grey. 
                                    This only provides a view for insertion site, which is not counted for charging"></i> : Length {{gene.saved_seq|length}} bp. Overall GC content {{ gene.modified_gc_content|floatformat }}%</p>
                                <div class="card">
                                    <div {% if gene.status != 'saved' %} style="display:none" {% endif %} class="card-body text-truncate second_col_trun" contenteditable="false" id="edited-sequence-trun">
                                        {{ gene.saved_seq|highlight_sequence_no_offset:gene.modified_highlights|safe }}
                                        {{ gene.saved_seq}}
                                    </div>
                                    <div {% if gene.status == 'saved' %} style="display:none" {% endif %} class="card-body monospace-text second_col_full" contenteditable="true" id="edited-sequence">
                                        {{ gene.saved_seq|highlight_sequence_no_offset:gene.modified_highlights|safe }}
                                    </div>
                                </div>
                            </div>
                            <!-- Third Column Edit Buttons -->
                            <div class="col-md-2 col-12 edit-buttons" {% if gene.status == 'saved' %} style="display:none" {% endif %}>
                                <p>Choose Species:</p>
                                <div class="mt-3 species-select-container" style="max-width:182px;">
                                        <select class="form-select species-select" id="species_select_{{ gene.id }}"  name="species_select">
                                            <option value="" {% if not gene.species or not gene.species.species_name %}selected{% endif %}>Choose a species</option>
                                            {% for species in species_names %}
                                                <!-- 检查当前gene的species是否等于循环中的species -->
                                                <!-- Add numbers by using the forloop.counter -->
                                                <option value="{{ species }}" {% if gene.species and species == gene.species.species_name %}selected{% endif %}>
                                                    {{ forloop.counter }}. {{ species }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <!-- 将gene.id传递到后端 -->
                                        <input type="hidden" class="gene-id" value="{{ gene.id }}">
                                </div>
                                <div class="mt-3">
                                    <label for="frameshiftSelector">Choose frameshift:</label>
                                    <select id="frameshiftSelector" class="form-select" style="max-width:182px;">
                                        <option value="0" selected>0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                    </select>
                                    <button class="btn btn-warning toggle-btn mt-3" data-displayed="false">Toggle Codon Boxes</button>
                                </div>
                                <div>
                                    <button class="btn btn-primary mt-3 analysis-btn" data-gene-id="{{ gene.id }}">Re-analyze</button>
                                    <button {% if gene.status != "validated" %}  style="display:none" {% endif %} class="btn btn-success mt-3 canSave" data-url="{% url 'user_center:validation_save' gene.id %}">Save</button>
                                    <button {% if gene.status == "validated" %}  style="display:none" {% endif %} class="btn btn-secondary mt-3 noSave" disabled>Save</button>
                                </div>
                            </div>
                            <div class="col-md-2 col-12 saved-button" {% if gene.status != 'saved' %} style="display:none" {% endif %}>
                                <div class="mt-3">
                                    <button class="btn btn-primary mt-4 editButton" style="width:100px;" data-url="{% url 'user_center:gene_edit' gene.id %}">Edit</button>
                                </div>
                            </div>
                        </div>
                        <!-- 罚分 box -->
                        <div class="row mt-2">
                            <div class="col-md-10 col-12">
                                <div class="card">
                                    <ul>
                                        {% if gene.analysis_results.tandem_repeats_sequence %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ gene.analysis_results.tandem_repeats_positions }}">Check Tandem Repeats: {{ gene.analysis_results.tandem_repeats_sequence }},score: {{ gene.analysis_results.tandem_repeats_penalty_score}}</li>
                                        {% endif %}
                                        {% if gene.analysis_results.inverted_repeats_sequence %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ gene.analysis_results.inverted_repeats_sequence }}">Check Inverted Repeats: {{ gene.analysis_results.inverted_repeats_sequence }}, score: {{ gene.analysis_results.inverted_repeats_penalty_score}}</li>
                                        {% endif %}
                                        {% if gene.analysis_results.W12S12Motifs_sequence %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ gene.analysis_results.W12S12Motifs_sequence }}">Check W8S8 motif: {{ gene.analysis_results.W12S12Motifs_sequence }}, score: {{ gene.analysis_results.W12S12Motifs_penalty_score }}</li>
                                        {% endif %}
                                        {% if gene.analysis_results.homopolymers_sequence %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ gene.analysis_results.homopolymers_sequence }}">Check Homopolymers: {{ gene.analysis_results.homopolymers_sequence }}, score: {{ gene.analysis_results.homopolymers_penalty_score }}</li>
                                        {% endif %}
                                        {% if gene.analysis_results.LongRepeats_sequence %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ gene.analysis_results.long_repeats_sequence }}">Check Long Repeats: {{ gene.analysis_results.LongRepeats_sequence }}, score: {{ gene.analysis_results.LongRepeats_penalty_score}}</li>
                                        {% endif %}
                                        {% if gene.analysis_results.local_gc_content_sequence %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ gene.analysis_results.local_gc_content_sequence }}">Check Local GC content: {{ gene.analysis_results.local_gc_content_sequence }}, score: {{ gene.analysis_results.local_gc_content_penalty_score}}</li>
                                        {% endif %}
                                        {% if gene.analysis_results.palindromes_sequence %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ gene.analysis_results.palindromes_sequence }}">Check Palindromes: {{ gene.analysis_results.palindromes_sequence }}, score: {{gene.analysis_results.palindromes_penalty_score}}</li>
                                        {% endif %}
                                        {% if gene.analysis_results.lowGC_sequence %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ gene.analysis_results.lowGC_sequence }}"> Check LowGC: {{ gene.analysis_results.lowGC_sequence }}, score: {{ gene.analysis_results.lowGC_penalty_score }}</li>
                                        {% endif %}
                                        {% if gene.analysis_results.highGC_sequence %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ gene.analysis_results.highGC_sequence }}"> Check HighGC: {{ gene.analysis_results.highGC_sequence }}, score: {{ gene.analysis_results.highGC_penalty_score }}</li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- 密码子使用频次显示Box -->
                        <div class="row mt-2">
                            <div class="col-md-10 col-12">
                                <div class="card">
                                    <!-- Clickable text to trigger chart loading and toggle visibility -->
                                    <p>
                                        <span
                                            style="cursor: pointer; color: blue;"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapseChart-{{ gene.id }}"
                                            aria-expanded="false"
                                            aria-controls="collapseChart-{{ gene.id }}"
                                            onclick="loadChart('{{ gene.id }}', '{{ gene.original_seq|escapejs }}', '{{ gene.species.species_name|default:"Human"|escapejs }}')">
                                            <!-- Triangle icon indicating collapsibility -->
                                            <i id="icon-{{ gene.id }}" class="bi bi-caret-right"></i> Codon Usage Graph
                                        </span>
                                    </p>
                                    
                                    <!-- Collapsible container for the chart and loading spinner -->
                                    <div id="collapseChart-{{ gene.id }}" class="collapse" data-bs-parent=".row">
                                        <!-- Loading animation, initially hidden -->
                                        <div
                                            id="loading-{{ gene.id }}"
                                            class="spinner-border text-danger"
                                            role="status"
                                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <!-- Chart canvas, initially hidden -->
                                        <canvas id="codonUsageChart-{{ gene.id }}" style="height:300px; display: none;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<!-- bottom buttons -->
<div class="container fixed-bottom">
    <div class="col text-center">
        <a href="{% url 'user_center:order_create' %}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Add more Genes</a>
        <a href="{% url 'user_center:view_cart' %}" class="btn btn-primary"><i class="bi bi-cart3"></i> Go to Shopping Cart</a>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkOptimizationModal">
            <i class="bi bi-check2-all me-2"></i>Bulk Optimization
        </button>
        <!-- 总的按钮，加载所有序列的图表 -->
        <button class="btn btn-primary" onclick="loadAllCharts()">
        <i class="bi bi-bar-chart-line me-2"></i>Load All Codon Usage Charts</button>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script src="{% static 'species/amino_acid_data.js' %}"></script>
<script src="{% static 'species/species_data.js' %}"></script>

<script>
    // Bulk Optimization Modal
    $(document).ready(function() {
        var selectAllState = false;

        // Custom selectAll button
        $.fn.dataTable.ext.buttons.selectAll = {
            text: 'Select All',
            action: function (e, dt, node, config) {
                if (selectAllState) {
                    dt.rows({ search: 'applied' }).deselect();
                    node.text('Select All');
                } else {
                    dt.rows({ search: 'applied' }).select();
                    node.text('Deselect All');
                }
                selectAllState = !selectAllState;
            }
        };

        var table = $('#gene-table-datatable').DataTable({
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'selectAll',
                }
            ],
            select: {
                style: 'multi+shift'
            },
            columnDefs: [{
                orderable: false,
                className: 'select-checkbox',
                targets: 0
            }],
            order: [[ 1, 'asc' ]],
        });

        // Form submission handling
        $('#bulkOptimizationForm').on('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission

            // Get selected genes IDs
            var selectedGenes = table.rows({ selected: true }).nodes().to$().map(function() {
                return $(this).data('gene-id');
            }).get();

            // Validate if any gene is selected
            if (selectedGenes.length === 0) {
                var geneToast = new bootstrap.Toast(document.getElementById('geneToast'));
                geneToast.show();
                return;
            }

            // Validate species selection
            if ($('#speciesSelect').val() === "") {
                var speciesToast = new bootstrap.Toast(document.getElementById('speciesToast'));
                speciesToast.show();
                return;
            }

            // Set the hidden input value
            $('#selectedGenes').val(selectedGenes.join(','));

            // Submit the form
            this.submit();
        });
    });
</script>
<script>
    function getTagTextByHTML(html) {
        var tagged_seq = '';
        html.childNodes.forEach(function(item) {
            if(item.nodeType===Node.TEXT_NODE)  {
                tagged_seq += item.textContent;
                return;
            }
            if(item.childNodes[0] === undefined)
                return;
            item.childNodes[0].childNodes.forEach(function(item) {
                if(item.nodeType === Node.TEXT_NODE) {
                    tagged_seq += item.textContent;
                }
                else {
                    var tmp = item.innerText;
                    for(var i = 0;i < tmp.length;i++) {
                        item.innerText = tmp[i];
                        tagged_seq += item.outerHTML;
                    }
                }
            });
        });
        return tagged_seq;
    }

    function clickNewCodon(e, event) {
        // 替换codon
        e.setAttribute("aria-current", "true");
        e.parentElement.parentElement.parentElement.childNodes[0].innerText = e.innerText;
    }

    function displayCodonBoxes(editedSequenceDiv, shift, originalSeqContent) {
            let currentIndex = 0;
            let wrappedSeq = '';
            // 使用DOM解析器处理原始内容
            const tempDiv = document.createElement('div')
            tempDiv.innerHTML = originalSeqContent;

            // 递归函数来遍历节点并正确添加密码子框
            function processNode(node, index, length) {
                const begin = `<span class="codon"><span data-bs-toggle="dropdown">`;
                const end = `</span><ul class="dropdown-menu small-dropdown-menu"></ul></span></span>`;
                
                var len = node.nodeType === Node.TEXT_NODE? node.textContent.length : 1;
                    // 处理文本节点
                for (let i = 0; i < len; i++) {
                    var content;
                    if(node.nodeType === Node.TEXT_NODE){
                        if(!/[a-zA-Z]/.test(node.textContent[i])) continue;
                        content = node.textContent[i];
                    }
                    else{
                        if(!/[a-zA-Z]/.test(node.innerText)) continue;
                        content = node.outerHTML;
                    }
                    // 跳过非字母节点
                    if ((currentIndex - shift) % 3 === 0) {
                        wrappedSeq += begin;
                    }

                    wrappedSeq += content;
                                            
                    if ((currentIndex - shift + 1) % 3 === 0) {
                        wrappedSeq += end;
                    }
                    currentIndex++;
                }
            }
            var len = tempDiv.childNodes.length;
            tempDiv.childNodes.forEach((child,index) => processNode(child,index,len));
            editedSequenceDiv.innerHTML = wrappedSeq;

            document.querySelectorAll(".codon").forEach(function(codonBox, index) {
                var selector = codonBox.closest('.col-md-5').nextElementSibling.querySelector(".form-select");
                // 添加事件监听器
                addCodonBoxEventListeners(codonBox, selector);

            });
    }

    function getCodonDetail(specie_name, codon) {
        // Check if species object is defined and has the specie_name property
        if (species.hasOwnProperty(specie_name)) {
            // console.log("species: ", species);
            // Check if the codon exists for the given species
            const specieData = species[specie_name];
            // console.log("specieData: ", specieData);
            if (specieData.hasOwnProperty(codon)) {
                const acid = specieData[codon]["Amino acid"];
                // Check if amino acid data exists
                if (aminoAcid.hasOwnProperty(specie_name) && aminoAcid[specie_name].hasOwnProperty(acid)) {
                    return aminoAcid[specie_name][acid];
                }
            }
        }
        return null; // Return null if no matching data is found
    }

    // 添加事件监听器
    function addCodonBoxEventListeners(codonBox, selector) {
        codonBox.addEventListener("click", function(e, event) {
            const codon = codonBox.childNodes[0].textContent;
            // console.log("mouse select species and codon: ", selector.value, codon);
            const list = getCodonDetail(selector.value, codon);
            // console.log("get codon detail list: ", list)
            const item_begin = `<li><a class="dropdown-item small-dropdown-item" onclick="clickNewCodon(this,event)">`;
            const item_end = `</a></li>`;
            var ul = codonBox.querySelector("ul");
            if(list === null)
                return;
            ul.innerHTML = ""
            if(list.length > 0) {
                for (let i = 0; i < list.length; i++) {
                    // 追加列表元素
                    ul.innerHTML += (item_begin + list[i]["Triplet"] + item_end)
                }
            }
        });
        codonBox.addEventListener("mouseenter", function(e, event) {
            const codon = e.srcElement.innerText.toUpperCase();
            const list = getCodonDetail(selector.value, codon);
            if (list === null) {
                codonBox.setAttribute('title', "Unknown");
            }
            else{
                // var text = 'Triplet(' + list[0]["Amino acid"] + ')   Frequency  Fraction \n'
                var text = '\t ' + list[0]["Amino acid"] + ' \t Frequency  Fraction \n'
                list.forEach(function(item) {
                    var fre = item["Frequency"].toFixed(2).padEnd(9, ' ');
                    var fra = item["Fraction"].toFixed(2).padEnd(9, ' ');
                    // 尽量对齐，不足加空格
                    text += ('  ' + item["Triplet"] + " :").padEnd(13, ' ') + "  " + fre + "\t" + fra + '\n';
                });
                codonBox.setAttribute('title', text);
            }
        });
    }

    // 点击species_select按钮时，保存物种名称到数据库中, 这部分功能是完整的。
    document.querySelectorAll('.species-select').forEach(function(selectElement) {
        selectElement.addEventListener('change', function() {
            const species = this.value;
            const geneContainer = this.closest('.species-select-container');
            const geneId = geneContainer.querySelector('.gene-id').value;

            // 这里发送您的AJAX请求...
            $.ajax({
                url: '/user_center/save_species/',
                type: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data:JSON.stringify({
                    species: species,
                    gene_id: geneId,
                }),
                success: function(response) {
                    if(response.status === 'success') {
                        // alert(response.message); // 或其他方式显示成功消息
                        // location.reload();
                        console.log(response);
                    } else {
                        console.log(response);
                        alert(response.message); // 或其他方式显示错误消息
                    }
                },
                error: function() {
                    alert('请求失败'); // 或其他方式显示错误消息
                }
            });
        });
    });

    // 点击Toggle Codon Boxes按钮时，显示或隐藏codon框
    document.addEventListener("DOMContentLoaded", function() {
        const toggleButtons = document.querySelectorAll(".toggle-btn");
        const selectors = document.querySelectorAll("species-select");  // 获取所有的物种选择器

        // 为每个Toggle Codon Boxes按钮添加事件监听器
        toggleButtons.forEach(function(toggleButton) {
            const editedSequenceDiv = toggleButton.closest('.col-md-2').previousElementSibling.querySelector("#edited-sequence");
            const frameshiftSelector = toggleButton.closest('.col-md-2').querySelector("#frameshiftSelector");

            frameshiftSelector.addEventListener("change", function(e, event) {
                if (toggleButton.dataset.displayed === "true") {
                    displayCodonBoxes(editedSequenceDiv, parseInt(frameshiftSelector.value), getTagTextByHTML(editedSequenceDiv));
                }
            });

            toggleButton.addEventListener("click", function() {
                // console.log("click", toggleButton.dataset.displayed);
                if (toggleButton.dataset.displayed === "true") {
                    // 隐藏codon框
                    editedSequenceDiv.innerHTML = getTagTextByHTML(editedSequenceDiv);
                    toggleButton.dataset.displayed="false";
                } else {
                    // 显示codon框
                    displayCodonBoxes(editedSequenceDiv, parseInt(frameshiftSelector.value), editedSequenceDiv.innerHTML);
                    toggleButton.dataset.displayed="true";
                }
            });
        });

    });

</script>
<script>
    // 点击Re-analyze按钮时，发送请求
    document.addEventListener("DOMContentLoaded", function() {
        const analysisButtons = document.querySelectorAll(".analysis-btn"); 

        analysisButtons.forEach(function(analysisButton) {
            analysisButton.addEventListener("click", function() {
                const editedSequenceDiv = analysisButton.closest('.col-md-2').previousElementSibling.querySelector("#edited-sequence");
                const geneID = analysisButton.getAttribute("data-gene-id");
                const toggleButton = analysisButton.closest('.col-md-2').querySelector(".toggle-btn");
                const frameshiftSelector = analysisButton.closest('.col-md-2').querySelector("#frameshiftSelector");
                const canSaveButton = analysisButton.closest('.col-md-2').querySelector(".canSave");
                const noSaveButton = analysisButton.closest('.col-md-2').querySelector(".noSave");
                // 获取editedSequenceDiv的内容和geneName
                const sequenceContent = editedSequenceDiv.innerText;
        
                // 构建要发送的数据
                const data = {
                    sequence: sequenceContent,
                    gene_id: geneID,
                };
                // 创建一个新的XMLHttpRequest对象
                const xhr = new XMLHttpRequest();

                xhr.open('POST', `/user_center/gene_validation/`, true);

                // 设置请求头，以便服务器知道我们发送的是JSON数据
                xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                // 设置回调函数，处理响应数据
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        const response = JSON.parse(xhr.responseText);
                        // 你可以在这里加入处理响应数据的代码
                        if(response.status === 'success') {
                            // 弹窗提示
                            alert('Re-analyzed!');
                            if(toggleButton.dataset.displayed === "true") {
                                displayCodonBoxes(editedSequenceDiv, parseInt(frameshiftSelector.value), response.new_seq);
                            }
                            else
                                editedSequenceDiv.innerHTML = response.new_seq;
                            if(response.seq_status === 'validated') {
                                canSaveButton.style.display = "";
                                noSaveButton.style.display = "none";
                            }
                            else {
                                canSaveButton.style.display = "none";
                                noSaveButton.style.display = "";
                            }
                            // 刷新浏览器
                            window.location.reload();
                        } else if (response.status === 'error') {
                            alert(response.message);
                        }
                    };
                };

                // 发送请求
                xhr.send(JSON.stringify(data));
            });
        });
    });
</script>
<script>
    // for save button
    $(document).ready(function() {
        $('.canSave').on('click', function(e, event) {
            const url = $(this).data('url');
            const tmp = e.target.closest('.col-md-2')
            const tmp2 = e.target.closest('.mb-5')

            const editedSequenceDiv = tmp.previousElementSibling.querySelector("#edited-sequence");
            const toggleButton = tmp.querySelector(".toggle-btn");
            const frameshiftSelector = tmp.querySelector("#frameshiftSelector");
            const editButtons = e.target.closest('.edit-buttons')
            const savedButton = tmp2.querySelector('.saved-button')
            const first_col_trun = tmp2.querySelector('.first_col_trun')
            const first_col_full = tmp2.querySelector('.first_col_full')
            const second_col_trun = tmp2.querySelector('.second_col_trun')
            const second_col_full = tmp2.querySelector('.second_col_full')
            // 获取editedSequenceDiv的内容和geneName
            const sequenceContent = editedSequenceDiv.innerText;
            
            // 构建要发送的数据
            $.ajax({
                url: url,
                type: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data:JSON.stringify({
                    sequence: sequenceContent,
                }),
                success: function(response) {
                    if(response.status === 'success') {
                        // alert(response.message); // 或其他方式显示成功消息
                        alert('Save success!');
                        editedSequenceDiv.innerHTML = response.new_seq;
                        editButtons.style.display = "none";
                        savedButton.style.display = "";
                        first_col_full.style.display = "none";
                        first_col_trun.style.display = "";
                        second_col_full.style.display = "none";
                        second_col_trun.style.display = "";
                    } else {
                        // console.log(response);
                        alert(response.message); // 或其他方式显示错误消息
                    }
                },
                error: function() {
                    alert('请求失败'); // 或其他方式显示错误消息
                }
            });
        });
    });
    // for edit button
    $(document).ready(function() {
        $('.editButton').on('click', function(e, event) {
            const url = $(this).data('url');

            const savedButton = e.target.closest('.saved-button')
            const tmp = e.target.closest('.mb-5')

            const editButtons = tmp.querySelector('.edit-buttons')
            const first_col_trun = tmp.querySelector('.first_col_trun')
            const first_col_full = tmp.querySelector('.first_col_full')
            const second_col_trun = tmp.querySelector('.second_col_trun')
            const second_col_full = tmp.querySelector('.second_col_full')
            $.ajax({
                url: url,
                type: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                success: function(response) {
                    if(response.status === 'success') {
                        // alert(response.message); // 或其他方式显示成功消息
                        editButtons.style.display = "";
                        savedButton.style.display = "none";
                        first_col_full.style.display = "";
                        first_col_trun.style.display = "none";
                        second_col_full.style.display = "";
                        second_col_trun.style.display = "none";
                    } else {
                        alert(response.message); // 或其他方式显示错误消息
                    }
                },
                error: function() {
                    alert('请求失败'); // 或其他方式显示错误消息
                }
            });
        });
    });
</script>
<script>
    // 鼠标移动到序列时高亮：暂时还有bug
    document.querySelectorAll('.sequence-highlighter').forEach(function(item) {
        item.addEventListener('mouseenter', function() {
            // 提取序列部分，考虑到可能有分号分隔的多个序列
            const fullText = this.textContent.trim();
            const targetSequencePart = fullText.split(':')[1].split(',')[0].trim();  // 提取序列部分
            const targetSequences = targetSequencePart.split(';');  // 处理可能的多序列情况
            const targetId = this.getAttribute('data-target');
            const targetElement = document.querySelector(targetId);

            console.log('Target Sequences:', targetSequences);  // 打印目标序列
            console.log('Target ID:', targetId);  // 打印目标元素的ID

            if (targetElement) {
                let highlightedText = targetElement.innerHTML; // 使用 innerHTML 保留原始 HTML 格式

                targetSequences.forEach(sequence => {
                    // 转义序列中的特殊字符
                    const regex = new RegExp(sequence.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g');
                    highlightedText = highlightedText.replace(regex, 
                        `<span class="bg-warning text-dark">${sequence}</span>`);  // 替换文本以高亮显示
                });

                targetElement.innerHTML = highlightedText;  // 更新HTML内容
            }
        });

        item.addEventListener('mouseleave', function() {
            const targetId = this.getAttribute('data-target');
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                targetElement.innerHTML = targetElement.textContent; // 恢复原始文本内容
            }
        });
    });
</script>
<!-- Chart.js scripts -->
<script>
    // 顶部画图的处理
    const genesList = [
        {% for gene in gene_list %}
            {
                gene_classification: "{{ gene.status|default:'unknown' }}",
                saved_seq: "{{ gene.saved_seq|escapejs }}",
                modified_gc_content: {{ gene.modified_gc_content }},
                penalty_score: {{ gene.penalty_score|default:"0" }}
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const geneClassification = genesList.map(gene => gene.gene_classification || 'unknown');
    const geneLength = genesList.map(gene => gene.saved_seq.length);
    const gcContent = genesList.map(gene => gene.modified_gc_content);
    const geneComplexity = genesList.map(gene => gene.penalty_score);

    // 动态生成分类颜色
    const getColorForClassification = (classification) => {
        switch(classification) {
            case 'forbidden': return '#dc3545'; // 红色
            case 'validated': return '#28a745'; // 绿色
            default: return '#6c757d'; // 其他为灰色
        }
    };

    const classificationCounts = geneClassification.reduce((acc, classification) => {
        acc[classification] = (acc[classification] || 0) + 1;
        return acc;
    }, {});

    const classificationLabels = Object.keys(classificationCounts);
    const classificationData = Object.values(classificationCounts);
    
    // 为每种分类分配颜色
    const classificationColors = classificationLabels.map(label => getColorForClassification(label));

    const ctx1 = document.getElementById('geneClassificationChart').getContext('2d');
    const geneClassificationChart = new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: classificationLabels,
            datasets: [{
                data: classificationData,
                backgroundColor: classificationColors, // 使用动态分配的颜色
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });

    // 修改 GC 含量图表，确保横坐标为整数
    const ctx2 = document.getElementById('gcContentChart').getContext('2d');
    const gcContentScatterChart = new Chart(ctx2, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'GC Content',
                data: genesList.map((gene, index) => ({ x: index + 1, y: gene.modified_gc_content })), // 使用从 1 开始的整数作为横坐标
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(54, 162, 235, 1)',
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Gene Index'
                    },
                    ticks: {
                        stepSize: 1, // 强制横坐标为整数
                        callback: function(value) { return Number.isInteger(value) ? value : null; }
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'GC Content'
                    }
                }
            }
        }
    });

    const ctx3 = document.getElementById('geneLengthChart').getContext('2d');
    const geneLengthChart = new Chart(ctx3, {
        type: 'line',
        data: {
            labels: genesList.map((gene, index) => `Gene ${index + 1}`),
            datasets: [{
                label: 'Length',
                data: geneLength,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                fill: true,
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    beginAtZero: true
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    const ctx4 = document.getElementById('sequenceComplexityChart').getContext('2d');
    const sequenceComplexityChart = new Chart(ctx4, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Penalty Score',
                data: genesList.map((gene, index) => ({ x: index + 1, y: gene.penalty_score })), // 确保x从1开始
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderColor: 'rgba(255, 99, 132, 1)',
                pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(255, 99, 132, 1)'
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Gene Index'
                    },
                    ticks: {
                        stepSize: 1, // 设置步长为1
                        callback: function(value) { return Number.isInteger(value) ? value : null; } // 确保显示整数
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Penalty Score'
                    }
                }
            }
        }
    });
</script>
<script>
    // 定义遗传密码表，将密码子映射为氨基酸
    const codonTable = {
        'ATA':'I', 'ATC':'I', 'ATT':'I', 'ATG':'M',
        'ACA':'T', 'ACC':'T', 'ACG':'T', 'ACT':'T',
        'AAC':'N', 'AAT':'N', 'AAA':'K', 'AAG':'K',
        'AGC':'S', 'AGT':'S', 'AGA':'R', 'AGG':'R',
        'CTA':'L', 'CTC':'L', 'CTG':'L', 'CTT':'L',
        'CCA':'P', 'CCC':'P', 'CCG':'P', 'CCT':'P',
        'CAC':'H', 'CAT':'H', 'CAA':'Q', 'CAG':'Q',
        'CGA':'R', 'CGC':'R', 'CGG':'R', 'CGT':'R',
        'GTA':'V', 'GTC':'V', 'GTG':'V', 'GTT':'V',
        'GCA':'A', 'GCC':'A', 'GCG':'A', 'GCT':'A',
        'GAC':'D', 'GAT':'D', 'GAA':'E', 'GAG':'E',
        'GGA':'G', 'GGC':'G', 'GGG':'G', 'GGT':'G',
        'TCA':'S', 'TCC':'S', 'TCG':'S', 'TCT':'S',
        'TTC':'F', 'TTT':'F', 'TTA':'L', 'TTG':'L',
        'TAC':'Y', 'TAT':'Y', 'TAA':'*', 'TAG':'*',
        'TGC':'C', 'TGT':'C', 'TGA':'*', 'TGG':'W',
    };

    // 固定颜色顺序，从高到低的颜色依次为（绿色->蓝色->黄色->橙色->粉色->红色）：
    const colorPalette = ['#70AC48', '#5A9AD7', '#FFC100', '#ED7D31', '#FF00FE', '#FE0000'];

    // 定义横坐标氨基酸顺序
    const aminoAcidOrder = [
        "H (His)", "S (Ser)", "G (Gly)", "M (Met)", "I (Ile)", "T (Thr)", "A (Ala)", "L (Leu)",
        "R (Arg)", "D (Asp)", "W (Trp)", "K (Lys)", "V (Val)", "F (Phe)", "P (Pro)", "N (Asn)", 
        "Q (Gln)", "Y (Tyr)", "E (Glu)", "C (Cys)", "* (Stop)"
    ];

    // 定义氨基酸单字母简写到三字母简写的映射表
    const aminoAcidThreeLetterNames = {
        'H': 'H (His)', 'S': 'S (Ser)', 'G': 'G (Gly)', 'M': 'M (Met)', 'I': 'I (Ile)',
        'T': 'T (Thr)', 'A': 'A (Ala)', 'L': 'L (Leu)', 'R': 'R (Arg)', 'D': 'D (Asp)',
        'W': 'W (Trp)', 'K': 'K (Lys)', 'V': 'V (Val)', 'F': 'F (Phe)', 'P': 'P (Pro)',
        'N': 'N (Asn)', 'Q': 'Q (Gln)', 'Y': 'Y (Tyr)', 'E': 'E (Glu)', 'C': 'C (Cys)',
        '*': '* (Stop)'
    };

    // 计算DNA序列中的密码子使用次数
    function countCodonsInSequence(dnaSequence) {
        let codonCounts = {};
        for (let i = 0; i < dnaSequence.length; i += 3) {
            const codon = dnaSequence.slice(i, i + 3);
            const aminoAcid = codonTable[codon];
            if (aminoAcid) {
                if (!codonCounts[aminoAcid]) {
                    codonCounts[aminoAcid] = {};
                }
                codonCounts[aminoAcid][codon] = (codonCounts[aminoAcid][codon] || 0) + 1;
            }
        }
        return codonCounts;
    }


    function createCodonUsageChart(dnaSequence, species, geneId) {
        const canvas = document.getElementById('codonUsageChart-' + geneId);
        
        // Set the canvas width and height attributes
        canvas.width = canvas.parentElement.offsetWidth; // Set width to parent container's width
        canvas.height = 300;  // Fixed height in pixels

        const ctx = canvas.getContext('2d');

        // 获取DNA序列中的密码子使用次数
        const codonCounts = countCodonsInSequence(dnaSequence); 
        const codonUsageData = aminoAcid[species]; 

        let datasets = []; // 用于存储每个密码子的 `dataset`
        let labels = [];   // 用于存储每个氨基酸的标签

        // 遍历固定顺序的氨基酸列表
        aminoAcidOrder.forEach(threeLetterAminoAcid => {
            const aminoAcid = Object.keys(aminoAcidThreeLetterNames).find(key => aminoAcidThreeLetterNames[key] === threeLetterAminoAcid);

            if (codonUsageData[aminoAcid]) {
                let totalCodons = 0;
                
                // 获取该氨基酸的每个密码子的真实使用数据
                let codonRatios = codonUsageData[aminoAcid].map(item => {
                    const realCount = codonCounts[aminoAcid] && codonCounts[aminoAcid][item.Triplet] ? codonCounts[aminoAcid][item.Triplet] : 0;
                    totalCodons += realCount;
                    return {
                        codon: item.Triplet,
                        fraction: realCount,  // 实际使用次数
                        frequency: item.Fraction  // 用于颜色排序
                    };
                });

                // 对 codonRatios 进行排序
                codonRatios.sort((a, b) => b.frequency - a.frequency).reverse();

                // 将该氨基酸的标签添加到 X 轴标签中
                labels.push(aminoAcidThreeLetterNames[aminoAcid]);

                // 颜色分配
                const numberOfCodons = codonRatios.length;
                const selectedColors = colorPalette.slice(0, numberOfCodons).reverse();

                // 构建 `datasets`
                codonRatios.forEach((ratio, index) => {
                    let dataset = datasets.find(d => d.label === ratio.codon);
                    if (!dataset) {
                        dataset = {
                            label: ratio.codon,
                            backgroundColor: selectedColors[index], 
                            data: Array(labels.length - 1).fill(0) // 填充已有氨基酸位置的 0
                        };
                        datasets.push(dataset);
                    }
                    dataset.data.push((totalCodons > 0 ? (ratio.fraction / totalCodons) * 100 : 0));
                });

                // 对剩下的 dataset 填充 0
                datasets.forEach(dataset => {
                    if (dataset.data.length < labels.length) {
                        dataset.data.push(0); 
                    }
                });
            }
        });

        // 创建 Chart.js 图表
        const chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,  
                datasets: datasets,  
            },
            options: {
                responsive: false,  // 启用响应式行为
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true, 
                    },
                    y: {
                        stacked: true, 
                        beginAtZero: true,
                        max: 100, 
                        ticks: {
                            callback: function(value) {
                                return value + '%';  
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false  
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let codon = context.dataset.label || '';  
                                let value = context.raw || 0;  
                                return codon + ': ' + value.toFixed(2) + '%';  
                            }
                        }
                    }
                }
            }
        });
        
        // 隐藏加载动画
        document.getElementById('loading-' + geneId).style.display = 'none';

        return chartInstance;
    }

    // Store chart instances and loading states
    const charts = {};
    const isLoading = {};

    // Function to load chart when collapsible element is expanded
    function loadChart(geneId, dnaSequence, species) {
        const iconElement = document.getElementById('icon-' + geneId);
        const collapseElement = document.getElementById('collapseChart-' + geneId);

        // Toggle the icon state when collapsed or expanded
        collapseElement.addEventListener('shown.bs.collapse', function () {
            iconElement.classList.remove('bi-caret-right');
            iconElement.classList.add('bi-caret-down-fill');
        });

        collapseElement.addEventListener('hidden.bs.collapse', function () {
            iconElement.classList.remove('bi-caret-down-fill');
            iconElement.classList.add('bi-caret-right');
        });

        // Load the chart if it hasn't been loaded yet
        if (!charts[geneId]) {
            myFunction(geneId, dnaSequence, species);
        }
    }

    // Function to load the chart
    function myFunction(geneId, dnaSequence, species) {
        // console.log('Loading chart for gene:', geneId);
        // console.log('DNA Sequence:', dnaSequence);
        // console.log('Species:', species);

        const loadingIndicator = document.getElementById('loading-' + geneId);
        const canvas = document.getElementById('codonUsageChart-' + geneId);

        // Show loading animation
        loadingIndicator.style.display = 'block';

        // Prevent multiple loads
        if (isLoading[geneId]) {
            console.warn('Chart is already loading.');
            return;
        }
        isLoading[geneId] = true;

        // Destroy existing chart if it exists
        if (charts[geneId]) {
            charts[geneId].destroy();
            charts[geneId] = null;
        }

        // Simulate loading delay (optional)
        setTimeout(() => {
            try {
                charts[geneId] = createCodonUsageChart(dnaSequence, species, geneId);
                // console.log('Chart created successfully:', charts[geneId]);
            } catch (error) {
                console.error('Error creating chart:', error);
            } finally {
                // Hide loading animation, show canvas
                loadingIndicator.style.display = 'none';
                canvas.style.display = 'block';
                isLoading[geneId] = false;
            }
        }, 500); // 500ms delay simulating load
    }

    // 加载所有序列的图表
    function loadAllCharts() {
        const allGenes = [
            {% for gene in gene_list %}
            {
                id: '{{ gene.id }}',
                original_seq: '{{ gene.original_seq|escapejs }}',
                species: '{{ gene.species.species_name|default:"Human" }}'
            },
            {% endfor %}
        ];
        // console.log('All Genes:', allGenes);

        // 遍历所有的基因信息，并调用 myFunction() 为每个序列加载图表
        allGenes.forEach(gene => {
            myFunction(gene.id, gene.original_seq, gene.species);  // 传递 gene.id 和 gene.original_seq

            // 获取每个collapse元素并将其展开
            const collapseElement = document.getElementById('collapseChart-' + gene.id);
            const bsCollapse = new bootstrap.Collapse(collapseElement, {
                toggle: false
            });
            bsCollapse.show();  // 手动展开
        });
    }
</script>

{% endblock %}

