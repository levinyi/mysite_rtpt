{% extends "user_center/base.html" %}
{% load custom_filters %}
{% load static %}
{% block title %}Start Ordering {% endblock %}
{% block extra_head %}
<!-- Custom CSS -->
<style>
    .custom-workflow-container {
        display: flex;
        gap: 1rem;
        justify-content: space-between;
        align-items: center;
        position: relative;
        padding: 1rem 1.25rem;
    }

    .custom-workflow-step {
        text-align: center;
        flex: 1;
        position: relative;
        z-index: 1;
    }

    .custom-workflow-icon {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: #0d6efd;
        background: linear-gradient(145deg, #eff6ff, #f7fbff);
        border: 1px solid rgba(13,110,253,.12);
    }

    .custom-step-label {
        font-weight: bold;
        color: #495057;
        margin-top: .5rem;
    }

    /* connectors between steps */
    .custom-workflow-step:before {
        content: '';
        position: absolute;
        top: 22px;
        left: -50%;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, rgba(13,110,253,.12), rgba(13,110,253,.12));
        z-index: 0;
    }
    .custom-workflow-step:first-child:before { display: none; }

    .hero-card { background: linear-gradient(135deg, #f8fbff 0%, #f4f9ff 60%, #f8fff9 100%); }
    .section-hint { color: #6c757d; font-size: .9rem; }
</style>
{% endblock %}

{% block content %}

    <nav class="mt-2" aria-label="breadcrumb">
        <ol class="breadcrumb small">
            <li class="breadcrumb-item"><a href="{% url 'user_center:dashboard' %}" class="text-decoration-none">User Center</a></li>
            <li class="breadcrumb-item active" aria-current="page">Create Order</li>
        </ol>
    </nav>
    <!-- section title -->
    <div class="card mt-3 border-0 hero-card">
        <div class="card-body p-4 p-md-5">
            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
                <div>
                    <h4 class="mb-1">Start Ordering</h4>
                    <div class="section-hint">Choose a vector, paste sequences, then submit for validation.</div>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'user_center:manage_vector' %}" class="btn btn-outline-secondary"><i class="bi bi-diagram-3 me-1"></i>Manage Vectors</a>
                    <a href="{% url 'user_center:view_cart' %}" class="btn btn-primary"><i class="bi bi-cart3 me-1"></i>View Cart</a>
                </div>
            </div>
        </div>
        <div class="custom-workflow-container mb-3">
            <div class="custom-workflow-step">
                <div class="custom-workflow-icon"><i class="bi bi-journal-text"></i></div>
                <div class="custom-step-label">Choose Vector</div>
            </div>
            <div class="custom-workflow-step">
                <div class="custom-workflow-icon"><i class="bi bi-folder-check"></i></div>
                <div class="custom-step-label">Submit Sequence</div>
            </div>
            <div class="custom-workflow-step">
                <div class="custom-workflow-icon"><i class="bi bi-person-check"></i></div>
                <div class="custom-step-label">Sequence Validation</div>
            </div>
            <div class="custom-workflow-step">
                <div class="custom-workflow-icon"><i class="bi bi-check-lg"></i></div>
                <div class="custom-step-label">Order Complete</div>
            </div>
        </div>
    </div>

    <!-- Order Creation Form -->
    <div class="card mt-3 mb-5 shadow-sm">
        <div class="card-body p-4">
            <!-- Choose Vector -->
            <div class="mb-4">
                <div class="d-flex align-items-center justify-content-between">
                    <h5 class="mb-1"><i class="bi bi-1-circle me-2"></i>Choose Vector</h5>
                </div>
                <div class="section-hint mb-2">RootPath common vectors and your verified vectors are listed. Create your own vector in <a class="text-decoration-none" href="{% url 'user_center:manage_vector' %}">Manage Vectors</a>.</div>
                <div class="input-group input-group-sm mb-2" style="max-width: 420px;">
                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="vectorSearch" placeholder="Search vectors by name">
                </div>
                <select class="form-select mt-2" size="10" id="vector_id">
                    <option value="" selected>Choose a vector</option>
                    <optgroup label="RootPath Vectors">
                        {% for vector in company_vectors %}
                            <option value="{{ vector.id }}">{{ vector.vector_name }}</option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="Your Vectors">
                        {% for vector in customer_vectors %}
                            <option value="{{ vector.id }}">{{ vector.vector_name }} (user)</option>
                        {% endfor %}
                    </optgroup>
                </select>
            </div>
            <!-- Submit Sequence -->
            <div class="mt-4">
                <h5 class="mb-2"><i class="bi bi-2-circle me-2"></i>Submit Sequence</h5>
                <div class="card-body p-0">
                    <!-- Tab navigation -->
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="aa_sequence_tab" data-bs-toggle="tab" data-bs-target="#aa_sequence" type="button" role="tab" aria-controls="aa_sequence" aria-selected="true">
                            <i class="bi bi-activity me-1"></i>For Protein Sequence</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="nt_sequence_tab" data-bs-toggle="tab" data-bs-target="#nt_sequence" type="button" role="tab" aria-controls="nt_sequence" aria-selected="false">
                            <i class="bi bi-code-slash me-1"></i>For DNA Sequence</button>
                        </li>
                    </ul>
                    <!-- Tab content -->
                    <div class="tab-content" id="myTabContent">
                        <!-- For AA Sequence Tab Pane -->
                        <div class="tab-pane fade show active" id="aa_sequence" role="tabpanel" aria-labelledby="aa_sequence_tab">
                            <div id="excelTable2" class="mt-3"></div>
                            <div class="mt-3">
                                <button id="addRowBtn2" class="btn d-block"><i class="bi bi-plus-circle-dotted"></i></button>
                                <p class="mt-3 section-hint mb-1">Fill gene name, AA sequence, host species for codon optimization, and forbidden sequences. You may also download the template <a href="{% static 'files/RootPath_Submit_Sequence_Template.xlsx' %}" class="text-decoration-none">here</a>.</p>
                                <div class="small text-muted">
                                    <i class="bi bi-asterisk"></i> Fields with * are mandatory. <br>
                                    <i class="bi bi-question-circle"></i> Forbidden Sequence format: separate by ';' without spaces. Example: AAATTT;GGGCCC;AAAAAA. Sequences longer than 10,000 bp are not analyzed.
                                </div>
                            </div>
                            <button id="submitBtnAA" onclick="postDataFromAaSequence()" class="btn btn-primary mt-4">
                                <span class="btn-text"><i class="bi bi-clipboard-pulse"></i> Submit</span>
                                <span class="btn-loading" style="display: none;">
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    Processing...
                                </span>
                            </button>
                        </div>
                        <!-- For NT Sequence Tab Pane -->
                        <div class="tab-pane fade" id="nt_sequence" role="tabpanel" aria-labelledby="nt_sequence_tab">   
                            <div id="excelTable" class="mt-3"></div>
                            <div class="mt-3">
                                <button id="addRowBtn" class="btn d-block"><i class="bi bi-plus-circle-dotted"></i></button>
                                <p class="mt-3 section-hint mb-0">Provide gene names and DNA sequences, then click Submit for evaluation. Template is available <a href="{% static 'files/RootPath_Submit_Sequence_Template.xlsx' %}" class="text-decoration-none">here</a>.</p>
                            </div>
                            <button id="submitBtnNT" onclick="postDataFromNtSequence()" class="btn btn-primary mt-3">
                                <span class="btn-text"><i class="bi bi-clipboard-pulse"></i> Submit</span>
                                <span class="btn-loading" style="display: none;">
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    Processing...
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}
{% block javascript %}
<script>
    let hot1, hot2; // 在更高作用域声明变量以便在postData函数中使用
    let hot1Initialized = false;
    let hot2Initialized = false;

    let validationFailed = false; // 用于检查是否有单元格未通过验证

    // Tab切换事件监听
    $('#myTab button').on('shown.bs.tab', function (e) {
        const target = $(e.target).data("bs-target");
        if (target === '#nt_sequence' && !hot1Initialized) {
            initHot1();
            // console.log('init hot1');
            hot1Initialized = true;
        } else if (target === '#aa_sequence' && !hot2Initialized) {
            initHot2();
            // console.log('init hot2');
            hot2Initialized = true;
        }
    });

    // 生成基因名验证器
    function createGeneNameValidator() {
        let lastError = '';
        return function(value, callback) {
            var regex = /^[a-zA-Z0-9_-]{1,60}$/;
            if (!regex.test(value)) {
                lastError = 'Gene Name "' + value + '" is invalid. It must be 1-15 characters long and can only contain letters, numbers, underscores, and hyphens.';
                callback(false);
            } else {
                lastError = '';
                callback(true);
            }
            return lastError;
        };
    }
    // 生成序列验证器
    function createSequenceValidator() {
        let lastError = '';
        return function(value, callback) {
            var regex = /^[a-zA-Z0-9\*\n\r]*$/;
            if (!regex.test(value)) {
                lastError = 'Sequence "' + value + '" is invalid. It should not contain spaces, multiple lines, line breaks, or illegal characters.';
                callback(false);
            } else {
                lastError = '';
                callback(true);
            }
            return lastError;
        };
    }

    // 初始化第一个Tab的Handsontable, 在初始化函数中使用这些验证器
    function initHot1() {
        const container1 = document.querySelector('#excelTable');
        const geneNameValidator = createGeneNameValidator();
        const sequenceValidator = createSequenceValidator();

        hot1 = new Handsontable(container1, {
            // 配置
            colHeaders: ['Gene Name', 'Sequence', 'i5 Non-coding', 'i3 Non-coding'],
            rowHeaders: true,
            colWidths: [200, 600, 150, 150],  // 设置每列的宽度
            columns: [
                { data: 'GeneName', validator: geneNameValidator },
                { data: 'Sequence', validator: sequenceValidator },
                { data: 'i5NC', validator: sequenceValidator },
                { data: 'i3NC', validator: sequenceValidator },
            ],
            height: 'auto',
            width: 'auto',
            licenseKey: 'non-commercial-and-evaluation', // for non-commercial use only
        });

        hot1.addHook('afterValidate', function (isValid, value, row, prop, source) {
            if (!isValid) {
                validationFailed = true;
                let errorMessage = '';
                if (prop === 'GeneName') {
                    errorMessage = geneNameValidator(value, () => {});
                } else if (prop === 'Sequence') {
                    errorMessage = sequenceValidator(value, () => {});
                }
                alert('Validation error at row ' + (row + 1) + ': ' + errorMessage);
            }
        });
        // "+" 按钮的点击事件
        document.getElementById('addRowBtn').addEventListener('click', function () {
            hot1.alter('insert_row_below');
        });
    }

    function initHot2() {
        var speciesList = {{ species_names_json | safe }};

        const container2 = document.querySelector('#excelTable2');
        const geneNameValidator = createGeneNameValidator();
        const sequenceValidator = createSequenceValidator();
        hot2 = new Handsontable(container2, {
            // 配置
            colHeaders: ['Gene Name*', 'AA Sequence*', 'Species*', 'Forbidden Sequence <i class="bi bi-question-circle"></i>', "5' Non-coding Sequence", "3' Non-coding Sequence"],
            rowHeaders: true,
            colWidths: [100, 300, 100, 200, 200,200],  // 设置每列的宽度
            columns: [
                { data: 'GeneName', validator: geneNameValidator },
                { data: 'Sequence', validator: sequenceValidator },
                { type: 'dropdown', source: speciesList, data: 'Species' },
                { data: 'ForbiddenSequence' },
                { data: '5NC' },
                { data: '3NC' },
            ],
            // invalidCellClassName: 'bg-warning',
            height: 'auto',
            width: 'auto',
            licenseKey: 'non-commercial-and-evaluation', // for non-commercial use only
        });

        hot2.addHook('afterValidate', function (isValid, value, row, prop, source) {
            if (!isValid) {
                validationFailed = true;
                let errorMessage = '';
                if (prop === 'GeneName') {
                    errorMessage = geneNameValidator(value, () => {});
                } else if (prop === 'Sequence') {
                    errorMessage = sequenceValidator(value, () => {});
                }
                alert('Validation error at row ' + (row + 1) + ': ' + errorMessage);
            }
        });
        // "+" 按钮的点击事件
        document.getElementById('addRowBtn2').addEventListener('click', function () {
            hot2.alter('insert_row_below');
        });
    }

    // 页面加载时初始化第一个Tab的Handsontable
    initHot2();
    hot2Initialized = true;

    // 简易向量搜索过滤
    const vectorSearch = document.getElementById('vectorSearch');
    const vectorSelect = document.getElementById('vector_id');
    if (vectorSearch && vectorSelect) {
        vectorSearch.addEventListener('input', () => {
            const q = vectorSearch.value.toLowerCase().trim();
            // 遍历所有 option（包含 optgroup 内）
            Array.from(vectorSelect.querySelectorAll('option')).forEach(opt => {
                if (!opt.value) return; // 跳过 placeholder
                const match = opt.textContent.toLowerCase().includes(q);
                opt.hidden = !match;
            });
        });
    }

    function postDataFromNtSequence() {
        // 获取当前活动Tab的Handsontable数据
        const hotData = hot1.getData();

        // 获取下拉菜单的值
        const vectorSelect = document.querySelector('#vector_id');
        const vectorId = vectorSelect.options[vectorSelect.selectedIndex].value;

        // 检查是否选择了vector
        if (!vectorId) {
            alert('Please select a vector.');
            return;
        }
        // 检查是否有单元格未通过验证
        if (validationFailed) {
            alert('Please correct the errors(cells with red background) in the table.');
            validationFailed = false;
            return;
        }

        // 构建数据
        const data = {
            'vectorId': vectorId,
            'genetable': hotData,
        };

        // 检查数据是否为空
        let isEmpty = true;
        for (let row of hotData) {
            if (row.some(cell => cell !== null && cell !== '')) {
                isEmpty = false;
                break;
            }
        }

        if (isEmpty) {
            alert('Cannot submit an empty table.');
            return;
        }

        // 显示加载状态
        const submitBtn = document.getElementById('submitBtnNT');
        submitBtn.disabled = true;
        submitBtn.querySelector('.btn-text').style.display = 'none';
        submitBtn.querySelector('.btn-loading').style.display = 'inline-block';
        showLoading(); // 显示全局loading

        // 使用fetch API发送数据到服务器
        fetch('/user_center/order_create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading(); // 隐藏全局loading
            if(data.status == 'error') {
                // 恢复按钮状态
                submitBtn.disabled = false;
                submitBtn.querySelector('.btn-text').style.display = 'inline-block';
                submitBtn.querySelector('.btn-loading').style.display = 'none';
                alert(data.message);
            } else {
                // 跳转到载体分析页面
                window.location.href = '/user_center/view_cart/';
            }
        })
        .catch((error) => {
            hideLoading(); // 隐藏全局loading
            // 恢复按钮状态
            submitBtn.disabled = false;
            submitBtn.querySelector('.btn-text').style.display = 'inline-block';
            submitBtn.querySelector('.btn-loading').style.display = 'none';
            console.error('Error:', error);
            alert('An Error occurred while sending the data: ' + error);
        });
    }

    function postDataFromAaSequence() {
        const hotData = hot2.getData();
        const vectorSelect = document.querySelector('#vector_id');
        const vectorId = vectorSelect.options[vectorSelect.selectedIndex].value;
        // 检查是否选择了vector
        if (!vectorId) {
            alert('Please select a vector.');
            return;
        }
        // 检查是否有单元格未通过验证
        if (validationFailed) {
            alert('Please correct the errors(cells with red background) in the table.');
            validationFailed = false;
            return;
        }

        // const checkbox = document.querySelector('#inlineRadio2');
        // const isChecked = checkbox.checked;
        const data = {
            'vectorId': vectorId,
            'genetable': hotData,
            //'isChecked': isChecked,
        };
        // console.log(data);
        let isEmpty = true;
        for (let row of hotData) {
            if (row.some(cell => cell !== null && cell !== '')) {
                isEmpty = false;
                break;
            }
        }
        if (isEmpty) {
            alert('Cannot submit an empty table.');
            return;
        }

        // 显示加载状态
        const submitBtn = document.getElementById('submitBtnAA');
        submitBtn.disabled = true;
        submitBtn.querySelector('.btn-text').style.display = 'none';
        submitBtn.querySelector('.btn-loading').style.display = 'inline-block';
        showLoading(); // 显示全局loading

        // 使用fetch API发送数据到服务器
        fetch('/user_center/order_create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading(); // 隐藏全局loading
            if(data.status == 'error') {
                // 恢复按钮状态
                submitBtn.disabled = false;
                submitBtn.querySelector('.btn-text').style.display = 'inline-block';
                submitBtn.querySelector('.btn-loading').style.display = 'none';
                alert(data.message);
            } else if (data.status === 'info') {
                // 当收到状态为 'info' 的响应时跳转到指定页面
                window.location.href = '/user_center/view_cart/';
            } else {
                // 跳转到载体分析页面
                window.location.href = '/user_center/view_cart/';
            }
        })
        .catch((error) => {
            hideLoading(); // 隐藏全局loading
            // 恢复按钮状态
            submitBtn.disabled = false;
            submitBtn.querySelector('.btn-text').style.display = 'inline-block';
            submitBtn.querySelector('.btn-loading').style.display = 'none';
            console.error('Error:', error);
            alert('An Error occurred while sending the data: ' + error);
        });
    }
</script>
<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>
{% endblock %}
