{% extends "base.html" %}
{% load static %}

{% block title %}order{% endblock %}
{% block extra_head %}
    <style>
        .workflow-step {
            display: flex;
            align-items: center;
            flex-direction: column;
            padding: 20px;
        }
        .workflow-icon {
            background-color: #ffe6cc;
            padding: 30px;
            border-radius: 50%;
            margin-bottom: 10px;
        }
    </style>
{% endblock %}
{% block content %}
<div class="container">
    <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb" class="mt-2">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'user_center:dashboard' %}" class="text-decoration-none">User Center</a></li>
            <li class="breadcrumb-item active" aria-current="page"></li>
        </ol>
    </nav>
    <div class="card mt-5">
        <div class="card-header text-center">   
            <h2>Order Creation Process</h2>
        </div>
        <div class="d-flex justify-content-between mb-4 mt-3">
            <div class="workflow-step">
                <div class="workflow-icon mb-3">
                    <i class="bi bi-journal-text"></i>
                </div>
                Choose Vector
                {% comment %} <small>Choose the vector you want to use</small> {% endcomment %}
            </div>
            <div class="workflow-step">
                <div class="workflow-icon mb-3">
                    <i class="bi bi-display"></i>
                </div>
                Choose Species
                {% comment %} <small>Choose the species you want to use</small> {% endcomment %}
            </div>
            <div class="workflow-step">
                <div class="workflow-icon mb-3">
                    <i class="bi bi-folder-check"></i>
                </div>
                Submit Sequence
                {% comment %} <small>Submit the sequence you want to synthesis</small> {% endcomment %}
            </div>
            <div class="workflow-step">
                <div class="workflow-icon mb-3">
                    <i class="bi bi-person-check"></i>
                </div>
                Sequence Validation
                {% comment %} <small>Check the sequence you submitted</small> {% endcomment %}
            </div>
            <div class="workflow-step">
                <div class="workflow-icon mb-3">
                    <i class="bi bi-check-lg"></i>
                </div>
                Order Complete
                {% comment %} <small>Order complete and pay</small> {% endcomment %}
            </div>
        </div>
    </div>
    <div class="card mt-5">
        <div class="card-header text-center">
            <h2>Start Ordering</h2>
        </div>
        <div class="card-body">
            <div class="card-title mb-3 mt-2">
                <h3><i class="bi bi-1-circle"></i> Choose Vectors</h3>
                <p>If your vector is not listed below, you can create your own vector <a class="text-decoration-none" href="{% url 'user_center:manage_vector' %}">here</a> first.</p>
            </div>
            <span class="text-success">Rootpath Vectors</span> and <span class="text-info">your own vectors</span> are listed below.
            <select class="form-select mt-2" size="5" aria-label="Multiple select example" id="vector_id">
                <option value="" selected >Choose a vector</option>
                {% for vector in company_vectors %}
                <option value="{{ vector.id }}" class="text-success">{{ vector.vector_name }} (RootPath)</option>
                {% endfor %}

                {% for vector in customer_vectors %}
                <option value="{{ vector.id }}" class="text-info">{{ vector.vector_name }} (user)</option>
                {% endfor %}
            </select>
            <div class="card-title mb-3 mt-5">
                <h3><i class="bi bi-2-circle"></i> Choose Species (Optional)</h3>
                <p class="mt-3">We have listed <span class="text-primary">{{species_list.count}}</span> species below, you can choose one species.</p>
                <p>The Species is used for codon optimizer, If you can't find the species you want, you can contact us to add it. <span class="text-danger">Or leave it blank.</span></p>
            </div>
            <select class="form-select" size="8" aria-label="Multiple select example" id="species_name">
                <option selected value="">Choose a species</option>
                {% for species in species_list %}
                <option value="{{ species.id }}">{{ species.species_name }}</option>
                {% endfor %}
            </select>
            <div class="card-title mb-3 mt-5">
                <h3><i class="bi bi-3-circle"></i> Submit Sequence</h3> <span class="text-danger">(Currently, we only support nucleotide sequences; amino acid sequence is still in the testing phase.)</span>
                <p class="mt-3">Provide the gene name, nucleotide or amino acid sequence, and forbidden sequences for each sequence.</p>
            </div>
            <div id="excelTable" class="mt-3">
                <button onclick="postData()" class="btn btn-primary mt-4"><i class="bi bi-clipboard-pulse"></i> Submit & Analyze Sequences</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block javascript %}
<script>
    const container = document.querySelector('#excelTable');
    const hot = new Handsontable(container, {
        colHeaders: ['Gene Name', 'NT|AA Sequence', 'ForbiddenSeqs'],
        rowHeaders: true,
        colWidths: [300, 600, 300],  // 设置每列的宽度
        columns: [
            { data: 'GeneName' },
            { data: 'Sequence' },
            { data: 'forbiddenSeqs' },
        ],
        height: 'auto',
        licenseKey: 'non-commercial-and-evaluation', // for non-commercial use only
    });

    function postData() {
        // console.log('postData function is called.')
        // 获取Handsontable中的数据
        const hotData = hot.getData();
        // console.log('hotData:', hotData);

        // 获取下拉菜单的值
        const vectorSelect = document.querySelector('#vector_id');
        const vectorId = vectorSelect.options[vectorSelect.selectedIndex].value;
        const speciesSelect = document.querySelector('#species_name');
        const speciesId = speciesSelect.options[speciesSelect.selectedIndex].value;
        // console.log(vectorId, speciesId);

        // 检查是否选择了vector和species
        if (!vectorId) {
            alert('Please select a vector.');
            return;
        }

        if (!speciesId) {
            alert('Please select a species.');
            return;
        }

        // 构建数据
        const data = {
            'vectorId': vectorId,
            'speciesId': speciesId,
            'genetable': hotData
        };

        // 检查数据是否为空
        let isEmpty = true;
        for (let row of hotData) {
            if (row.some(cell => cell !== null && cell !== '')) {
                isEmpty = false;
                break;
            }
        }

        if (isEmpty) {
            alert('Cannot submit an empty table.');
            return;
        }

        // 使用fetch API发送数据到服务器
        fetch('/user_center/add_to_cart/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
            if(data.status == 'error') {
                alert(data.message);
    
            } else {
                // 跳转到载体分析页面
                window.location.href = '/user_center/gene_detail/';
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('An Error occurred while sending the data:', error);
        });
    }
</script>
{% endblock %}
