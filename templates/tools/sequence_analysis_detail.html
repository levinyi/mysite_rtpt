{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<style>
    /* 进度条照旧使用 Flex 布局 */
    .progress {
        overflow: hidden;        /* 不让 min-width 段溢出条容器 */
        height: 1.25rem;         /* 稍微高一点，数字更清晰 */
    }
    
    /* 通用：让数字在条中水平居中 */
    .progress-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: .75rem;       /* 数字不要太大，避免拥挤 */
        line-height: 1.25rem;
    }
    
    /* 关键：如果段太窄，给它最小宽度 */
    .progress-bar.too-narrow {
        min-width: 30px;         /* 你可以改成 24–40px 之间的任意值 */
    }
</style>
    
{% endblock %}

{% block content %}
<div class="container mt-3">
    <!-- 顶部信息 -->
    <div class="row">
        <div class="col-md-8">
            <h2>Sequence Analysis Results</h2>
            <p class="mb-0">
                Total Genes: {{ gene_table|length }}
                <i class="bi bi-question-circle-fill ms-1 text-muted"
                   data-bs-toggle="tooltip"
                   data-bs-placement="right"
                   title="Total penalty score of each sequence is the sum of all feature-specific penalty scores. 
                          Green: score = 0; Yellow: 0 < score ≤ 28; Red: score > 28.">
                </i>
              </p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'tools:download_gene_table' %}" id="downloadButton" class="btn btn-primary"><i class="bi bi-download me-2"></i> Download CSV</a>
        </div>
        <div class="col-12 mt-2">
            <div class="progress">
                {# 绿色段 #}
                <div class="progress-bar bg-success position-relative
                            {% if green_percentage < 3 %}too-narrow{% endif %}"
                     role="progressbar"
                     style="width: {{ green_percentage }}%"
                     aria-valuenow="{{ green_percentage }}" aria-valuemin="0" aria-valuemax="100">
                    <span class="text-dark">{{ green_count }}</span>
                </div>
            
                {# 黄色段 #}
                <div class="progress-bar bg-warning position-relative
                            {% if yellow_percentage < 3 %}too-narrow{% endif %}"
                     role="progressbar"
                     style="width: {{ yellow_percentage }}%"
                     aria-valuenow="{{ yellow_percentage }}" aria-valuemin="0" aria-valuemax="100">
                    <span class="text-dark">{{ yellow_count }}</span>
                </div>
            
                {# 红色段 #}
                <div class="progress-bar bg-danger position-relative
                            {% if red_percentage < 3 %}too-narrow{% endif %}"
                     role="progressbar"
                     style="width: {{ red_percentage }}%"
                     aria-valuenow="{{ red_percentage }}" aria-valuemin="0" aria-valuemax="100">
                    <span class="text-light">{{ red_count }}</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Gene Table -->
    <div class="row mt-3">
        {% for g in gene_table %}
        <div class="col-12 mb-2">
            <!-- Gene Card -->
            <div class="card">
                <div class="card-header {% if g.total_penalty_score == 0 %}bg-success{% elif g.total_penalty_score <= 28 %}bg-warning{% elif g.total_penalty_score > 28 %}bg-danger{% endif %}">
                    <div class="row">
                        <div class="col-6 text-start">
                            Gene ID: {{ g.gene_id }}
                        </div>
                        <div class="col-6 text-end" data-bs-toggle="tooltip" data-bs-placement="right" title="green: score is 0; yellow:0<score<28; red:score>28">
                            Total Penalty Score: {{ g.total_penalty_score }}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text" id="seq-{{ forloop.counter }}">{{ g.sequence }}</p>
                    <!-- Accordion for details -->
                    <div class="accordion" id="accordion{{ forloop.counter }}">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false" aria-controls="collapse{{ forloop.counter }}">
                                    Show More Details
                                </button>
                            </h2>
                            <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#accordion{{ forloop.counter }}">
                                <div class="accordion-body">
                                    <!-- Display other information as list -->
                                    <ul>
                                        {% if g.tandem_repeats_sequence %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ g.tandem_repeats_positions }}">
                                            Check Tandem Repeats: {{ g.tandem_repeats }},score: {{ g.tandem_repeats_penalty_score}}</li>
                                        {% endif %}
                                        {% if g.inverted_repeats_sequence %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ g.inverted_repeats_sequence }}">
                                            Check Inverted Repeats: {{ g.inverted_repeats }}, score: {{ g.inverted_repeats_penalty_score}}</li>
                                        {% endif %}
                                        {% if g.W12S12Motifs %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ g.W12S12Motifs }}">
                                            Check W12S12 motif: {{ g.W12S12Motifs }}. score: {{ g.W12S12Motifs_penalty_score }}.
                                        </li>
                                        {% endif %}
                                        {% if g.Homopolymers %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ g.Homopolymers }}">
                                        Check Homopolymers: {{ g.Homopolymers }}, score: {{ g.Homopolymers_penalty_score }}</li>
                                        {% endif %}
                                        {% if g.LongRepeats %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ g.LongRepeats }}">
                                        Check Long Repeats: {{ g.LongRepeats }}, score: {{ g.LongRepeats_penalty_score}}</li>
                                        {% endif %}
                                        
                                        {% if g.palindromes %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ g.palindromes }}">
                                        Check Palindromes: {{ g.Palindromes }}, score: {{g.Palindromes_penalty_score}}</li>
                                        {% endif %}
                                        {% if g.LowGC %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ g.LowGC }}">
                                        Check LowGC: {{ g.LowGC }}, score: {{ g.LowGC_penalty_score }}</li>
                                        {% endif %}
                                        {% if g.HighGC %}
                                        <li class="sequence-highlighter" data-target="#seq-{{ forloop.counter }}" data-positions="{{ g.HighGC }}">
                                        Check HighGC: {{ g.HighGC }}, score: {{ g.HighGC_penalty_score }}</li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
    let allowUnload = true;  // Flag to determine if the unload prompt should be shown

    // 当文档加载完成后，添加事件监听器
    window.addEventListener('DOMContentLoaded', function () {
        // 下载按钮的点击事件监听器，用于取消卸载警告
        const downloadButton = document.getElementById('downloadButton');
        if (downloadButton) {
            downloadButton.addEventListener('click', function (e) {
                e.preventDefault();   // 阻止默认行为
                allowUnload = false;  // 当按钮被点击时，设置标志为false
                window.location.href = "/tools/download_gene_table/";  // 重定向到下载链接
            });
        }

        document.querySelectorAll('.sequence-highlighter').forEach(function(item) {
            item.addEventListener('mouseenter', function() {
                // 1) Get the full text in this <li>
                const fullText = this.textContent.trim();
                // console.log('Full Text:', fullText);
 
                // 2) Extract substring(s) that appear after "sequence:" and before the next '|' character
                //    This RegExp looks for "sequence:" followed by any non-'|' characters. 'g' for multiple matches.
                const regex = /sequence:\s*([^|]+)/gi;
                let match;
                const extractedSeqs = [];
                while ((match = regex.exec(fullText)) !== null) {
                    const seq = match[1].trim();
                    if (seq) extractedSeqs.push(seq);
                }
                // console.log('Extracted Sequences:', extractedSeqs);
 
                // 3) Get the target element, whose ID is in data-target
                const targetId = this.getAttribute('data-target');
                const targetElement = document.querySelector(targetId);
                if (!targetElement) return;
 
                // 4) Highlight the extracted sequences inside the target element
                let highlightedText = targetElement.textContent;
                extractedSeqs.forEach(sequence => {
                    // case-insensitive global matching
                    const re = new RegExp(sequence, 'gi');
                    highlightedText = highlightedText.replace(
                        re,
                        '<span class="bg-warning text-dark">$&</span>'
                    );
                });
                targetElement.innerHTML = highlightedText;
            });
 
            item.addEventListener('mouseleave', function() {
                // restore original text
                const targetId = this.getAttribute('data-target');
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    targetElement.innerHTML = targetElement.textContent;
                }
            });
        });
    });

    // 注册 beforeunload 事件监听器
    window.addEventListener('beforeunload', function (e) {
        // console.log("allowUnload: ", allowUnload); // 打印当前的 allowUnload 值
        if (!allowUnload) return;  // 如果标志为false，不显示警告
        var confirmationMessage = 'Are you sure you want to leave this page?';
        (e || window.event).returnValue = confirmationMessage; // Gecko and Trident
        return confirmationMessage; // Gecko and WebKit
    });
</script>

{% endblock %}
