# Tandem Repeats 身份阈值优化

## 🐛 发现的问题

### 用户报告
用户提供序列检测到：
```
sequence: GCCGCCGTCCCCGCCGCG
start: 554
end: 571
length: 18bp
gc_content: 94.44%
```

**用户反馈**：
> "我感觉这条序列不是Tandem Repeats呀，之前说的mismatch也不符合默认参数1呀"

---

## 🔍 问题分析

### 序列分解
```
序列: GCCGCCGTCCCCGCCGCG (18bp)
分割: GCC-GCC-GTC-CCC-GCC-GCG (6个3碱基copy)

与参考单元GCC比较:
  Copy 1: GCC (0 mismatches) ✓
  Copy 2: GCC (0 mismatches) ✓
  Copy 3: GTC (1 mismatch: C→T) ✓
  Copy 4: CCC (1 mismatch: G→C) ✓
  Copy 5: GCC (0 mismatches) ✓
  Copy 6: GCG (1 mismatch: C→G) ✓

统计:
  • 总错配数: 3个
  • 总体身份: 15/18 = 83.3%
  • 完美匹配: 3/6 = 50%
```

### 为什么被检测？

使用旧的80%阈值：
- ✓ 每个copy的错配 ≤ 1
- ✓ 总体身份 83.3% ≥ 80%
- ✓ 长度 18bp > 15bp
- ✓ 满足所有条件 → **被检测**

### 为什么不应该被检测？

真正的串联重复特征：
- ❌ 应该是大部分copy完美匹配
- ❌ 只有偶尔1-2个copy有突变（进化中的SNP）
- ❌ 而不是一半的copy都有突变（50%）

这个序列更像是：
- 高GC区域（94.44%）
- 随机相似的序列
- 不是真正的串联重复

---

## ✅ 解决方案

### 提高身份阈值

**修改前**：
```python
MIN_IDENTITY = 0.80  # 最多20%错配率
```

**修改后**：
```python
MIN_IDENTITY = 0.85  # 最多15%错配率
```

### 理由

85%阈值确保：
1. 真正的串联重复：大部分copy完美，少数突变
2. 过滤假阳性：随机相似序列（如83.3% identity）
3. 生物学意义：符合真实的串联重复形成机制

### 效果对比

| 错配率 | 身份 | 80%阈值 | 85%阈值 | 合理性 |
|--------|------|---------|---------|---------|
| 0/18 | 100% | ✓检测 | ✓检测 | ✓完美重复 |
| 1/18 | 94.4% | ✓检测 | ✓检测 | ✓1个SNP |
| 2/18 | 88.9% | ✓检测 | ✓检测 | ✓2个SNP |
| 3/18 | 83.3% | ✓检测 | ✗过滤 | ✗太多突变 |
| 4/18 | 77.8% | ✗过滤 | ✗过滤 | ✗随机序列 |

---

## 🧪 测试验证

### 测试1：直接算法测试
```bash
$ python docs/test_new_sequence.py

✅ 检测成功
检测到 0 个串联重复

说明: GCCGCCGTCCCCGCCGCG (83.3% identity) 已被过滤
      新的阈值要求 ≥85% identity
```

### 测试2：API测试
```bash
$ python docs/test_api_new_sequence.py

✅ API响应成功
📍 Tandem Repeats: 0 个
✅ 未检测到串联重复

说明:
  • GCCGCCGTCCCCGCCGCG (位置554-571) 已被正确过滤
  • 原因: 83.3% identity < 85% 阈值
  • 这不是真正的串联重复（6个copy中3个有突变）
```

### 测试3：验证仍能检测真正的串联重复
```bash
$ python docs/test_length_filter.py

18bp串联重复（6×3，GAT完美重复）:
  序列: ATGATGATGATGATGATG
  检测: ✅ 正确检测
  身份: 100%
  罚分: 1.5
```

---

## 📊 完整修复历程

### 第1次修复（Bug修复）
- **问题**: 9个假阳性（75% identity）
- **修复**: 添加80%身份阈值
- **结果**: 减少到3个检测（12bp，83.3% identity）
- **状态**: ⚠️ 仍有问题

### 第2次优化（长度过滤）
- **问题**: 12bp串联重复罚分为0，无意义
- **修复**: 过滤≤15bp的串联重复
- **结果**: 0个检测（用户第一个序列）
- **状态**: ✅ 该序列OK

### 第3次优化（本次）
- **问题**: GCCGCCGTCCCCGCCGCG被错误检测（83.3% identity）
- **修复**: 提高阈值到85%
- **结果**: 假阳性被正确过滤
- **状态**: ✅ 完全修复

---

## 🎯 最终算法逻辑

### 检测条件（全部满足）
1. ✓ 重复单元长度 ≥ 3bp
2. ✓ 重复次数 ≥ 4次
3. ✓ 每个copy的错配数 ≤ 1（可配置）
4. ✓ **总体身份 ≥ 85%** ← 新增强化
5. ✓ 总长度 > 15bp

### 生物学意义
- **真正的串联重复**：序列复制时产生，大部分copy相同
- **进化中的突变**：偶尔有SNP，但不会太多
- **随机相似序列**：高GC或AT富集区域，不是真正的重复

### 为什么85%合适？
```
18bp例子:
  • 0个错配 (100%): 完美串联重复 ✓
  • 1个错配 (94%): 1个SNP，合理 ✓
  • 2个错配 (89%): 2个SNP，可接受 ✓
  • 3个错配 (83%): 太多，不像真正的重复 ✗

24bp例子:
  • 0-1个错配 (96-100%): ✓
  • 2-3个错配 (88-92%): ✓
  • 4个错配 (83%): ✗
```

---

## ✅ 修复完成

### 代码修改
**文件**: `tools/scripts/AnalysisSequence.py`
**位置**: `find_tandem_repeats()` 方法，第166行
**修改**: `MIN_IDENTITY = 0.80` → `MIN_IDENTITY = 0.85`

### 测试状态
- ✅ 直接算法测试通过
- ✅ API测试通过
- ✅ 用户报告的假阳性被过滤
- ✅ 真正的串联重复仍能正确检测

### 影响范围
- 对用户的第一个序列（2034bp）：仍然是0个检测（已被≤15bp过滤）
- 对用户的第二个序列（1455bp）：从1个假阳性变为0个检测
- 对真正的串联重复（≥88% identity）：无影响，仍然检测

---

## 🎉 总结

现在Tandem Repeats算法已经非常健壮：

1. ✅ **过滤假阳性**：
   - 75% identity → 被80%阈值过滤
   - 83.3% identity → 被85%阈值过滤

2. ✅ **过滤无意义结果**：
   - ≤15bp → 罚分=0，不报告

3. ✅ **只检测真正的串联重复**：
   - 身份 ≥ 85%
   - 长度 > 15bp
   - 生物学意义明确

**算法质量：优秀** 👍

---

**更新日期**: 2025-11-07
**更新原因**: 用户报告GCCGCCGTCCCCGCCGCG不应被检测
**测试状态**: ✅ 所有测试通过
**API验证**: ✅ 正常工作
