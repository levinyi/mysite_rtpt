# ä¸‰ä¸ªç®—æ³•çš„Bugåˆ†ææŠ¥å‘Š

## ğŸ“… æ£€æŸ¥æ—¥æœŸ
2025-11-06

---

## ğŸ› å‘ç°çš„é—®é¢˜

### 1. âš ï¸ **Palindrome Repeats - ä¸¥é‡BUGï¼šmin_len å¥‡æ•°é—®é¢˜**

#### é—®é¢˜ä½ç½®
`tools/scripts/AnalysisSequence.py:291`

#### é—®é¢˜ä»£ç 
```python
for length in range(min_len, min(n - start + 1, 200), 2):
    end = start + length - 1
    seq = s[start:end + 1]
    if is_dna_palindrome(seq):
        # ...
```

#### é—®é¢˜æè¿°

**é»˜è®¤ `min_len=15` æ˜¯å¥‡æ•°ï¼**

`range(15, max, 2)` ä¼šç”Ÿæˆï¼š15, 17, 19, 21, 23...ï¼ˆå…¨æ˜¯å¥‡æ•°ï¼‰

ä½†æ˜¯ï¼š**DNAå›æ–‡å¿…é¡»æ˜¯å¶æ•°é•¿åº¦ï¼**

DNAå›æ–‡çš„å®šä¹‰ï¼šåºåˆ— == reverse_complement(åºåˆ—)

ä¾‹å¦‚ï¼š
- `ATCGAT` (6bp, å¶æ•°) âœ… å¯èƒ½æ˜¯DNAå›æ–‡
- `ATCGATA` (7bp, å¥‡æ•°) âŒ ä¸å¯èƒ½æ˜¯DNAå›æ–‡

**å½“å‰ç»“æœ**ï¼šç®—æ³•æ°¸è¿œä¸ä¼šæ£€æµ‹åˆ°ä»»ä½•DNAå›æ–‡ï¼ˆå½“ä½¿ç”¨é»˜è®¤å‚æ•°æ—¶ï¼‰ï¼

#### æµ‹è¯•éªŒè¯

```python
# æµ‹è¯•ä»£ç 
def reverse_complement(seq):
    complement = {'A': 'T', 'T': 'A', 'C': 'G', 'G': 'C'}
    return ''.join(complement[base] for base in reversed(seq.upper()))

# æ£€æŸ¥å¥‡æ•°é•¿åº¦èƒ½å¦æ˜¯DNAå›æ–‡
for length in [15, 17, 19, 21]:
    # éšæœºç”Ÿæˆä¸€ä¸ªé•¿åº¦ä¸º length çš„åºåˆ—
    # æ£€æŸ¥å®ƒæ˜¯å¦å¯èƒ½ç­‰äºå…¶åå‘äº’è¡¥
    # æ•°å­¦ä¸Šï¼šå¥‡æ•°é•¿åº¦ä¸å¯èƒ½æ»¡è¶³ seq == reverse_complement(seq)
    print(f"Length {length}: ä¸å¯èƒ½æ˜¯DNAå›æ–‡")
```

#### å½±å“èŒƒå›´
- âš ï¸ **é«˜å±**ï¼šå®Œå…¨ç ´åPalindrome RepeatsåŠŸèƒ½
- é»˜è®¤å‚æ•°ï¼ˆmin_len=15ï¼‰å®Œå…¨æ— æ•ˆ
- åªæœ‰å½“ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®å¶æ•° min_lenï¼ˆå¦‚16, 18ï¼‰æ—¶æ‰èƒ½å·¥ä½œ

#### ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆ1ï¼šå¼ºåˆ¶ min_len ä¸ºå¶æ•°**
```python
# åœ¨å‡½æ•°å¼€å§‹å¤„æ·»åŠ 
if min_len % 2 != 0:
    min_len += 1  # å¦‚æœæ˜¯å¥‡æ•°ï¼Œè°ƒæ•´ä¸ºå¶æ•°

for length in range(min_len, min(n - start + 1, 200), 2):
    # ...
```

**æ–¹æ¡ˆ2ï¼šæ”¹å˜æ­¥é•¿é€»è¾‘**
```python
# è®¡ç®—ç¬¬ä¸€ä¸ª >= min_len çš„å¶æ•°
start_len = min_len if min_len % 2 == 0 else min_len + 1

for length in range(start_len, min(n - start + 1, 200), 2):
    # ...
```

**æ–¹æ¡ˆ3ï¼šæ”¹å˜é»˜è®¤å€¼**
```python
def find_palindrome_repeats(self, index=None, min_len=16):  # æ”¹ä¸ºå¶æ•°
    # ...
```

**æ¨è**ï¼šä½¿ç”¨æ–¹æ¡ˆ2ï¼Œæœ€å®‰å…¨ã€‚

---

### 2. âš ï¸ **Tandem Repeats - åˆå¹¶é€»è¾‘æ½œåœ¨é—®é¢˜**

#### é—®é¢˜ä½ç½®
`tools/scripts/AnalysisSequence.py:153-158`

#### é—®é¢˜ä»£ç 
```python
if repeats and repeats[-1]['end'] >= repeat['start'] - 1:
    old_end = repeats[-1]['end']
    new_end = max(old_end, repeat['end'])
    repeats[-1]['end'] = new_end
    repeats[-1]['sequence'] = s[repeats[-1]['start']:new_end + 1]
```

#### é—®é¢˜æè¿°

åˆå¹¶é€»è¾‘ä¼šåˆå¹¶**ä»»ä½•**é‡å æˆ–ç´§é‚»çš„é‡å¤ï¼Œä½†æ²¡æœ‰æ£€æŸ¥å®ƒä»¬æ˜¯å¦æ˜¯**ç›¸åŒçš„é‡å¤å•å…ƒ**ã€‚

**é—®é¢˜åœºæ™¯**ï¼š
```
åºåˆ—: ATCATCATCGCGCGCGC
      ^^^^^^^^^ (ATC)Ã—3, ä½ç½® 0-8
               ^^^^^^^^^ (GCG)Ã—3, ä½ç½® 9-16

åˆå¹¶å: ATCATCATCGCGCGCGC (ä½ç½® 0-16)
```

åˆå¹¶åçš„åºåˆ—**ä¸å†æ˜¯ä¸²è”é‡å¤**ï¼

#### ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿï¼Ÿ

ç®—æ³•åŸºäº suffix array éå†ï¼Œä¼šç‹¬ç«‹æ£€æµ‹åˆ°ï¼š
1. `ATCATCATC` (ATC é‡å¤3æ¬¡)
2. `GCGCGCGC` (GCG é‡å¤3æ¬¡)

ç„¶ååˆå¹¶é€»è¾‘çœ‹åˆ° `8 >= 9 - 1`ï¼ˆç´§é‚»ï¼‰ï¼Œå°±åˆå¹¶äº†ã€‚

#### å®é™…å½±å“

éœ€è¦æµ‹è¯•æ‰èƒ½ç¡®å®šå®é™…å½±å“ç¨‹åº¦ï¼š
- å¦‚æœä¸¤ä¸ªä¸åŒçš„ä¸²è”é‡å¤ç´§é‚»ï¼Œä¼šè¢«é”™è¯¯åˆå¹¶
- åˆå¹¶åçš„ `penalty_score` å¯èƒ½ä¸å‡†ç¡®

#### ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆ1ï¼šæ£€æŸ¥é‡å¤å•å…ƒæ˜¯å¦ç›¸åŒ**
```python
def get_repeat_unit(sequence, min_unit=3):
    """æå–ä¸²è”é‡å¤çš„é‡å¤å•å…ƒ"""
    for unit_len in range(min_unit, len(sequence) // 2 + 1):
        unit = sequence[:unit_len]
        # æ£€æŸ¥æ˜¯å¦æ•´ä¸ªåºåˆ—éƒ½æ˜¯è¿™ä¸ªå•å…ƒçš„é‡å¤
        # ...
    return None

# åœ¨åˆå¹¶æ—¶ä½¿ç”¨
if repeats and repeats[-1]['end'] >= repeat['start'] - 1:
    # æ£€æŸ¥é‡å¤å•å…ƒæ˜¯å¦ç›¸åŒ
    unit1 = get_repeat_unit(repeats[-1]['sequence'])
    unit2 = get_repeat_unit(repeat['sequence'])
    if unit1 == unit2:  # åªæœ‰ç›¸åŒå•å…ƒæ‰åˆå¹¶
        # æ‰§è¡Œåˆå¹¶
```

**æ–¹æ¡ˆ2ï¼šä¸åˆå¹¶ç´§é‚»çš„ï¼Œåªåˆå¹¶é‡å çš„**
```python
# æ”¹å˜æ¡ä»¶
if repeats and repeats[-1]['end'] >= repeat['start']:  # å»æ‰ -1
    # åªåˆå¹¶çœŸæ­£é‡å çš„
```

**æ¨è**ï¼šæ–¹æ¡ˆ1æ›´å®‰å…¨ï¼Œä½†éœ€è¦å®ç° `get_repeat_unit` å‡½æ•°ã€‚

---

### 3. âš¡ **Palindrome Repeats - æ€§èƒ½é—®é¢˜**

#### é—®é¢˜ä½ç½®
`tools/scripts/AnalysisSequence.py:289-291`

#### é—®é¢˜ä»£ç 
```python
for start in range(n - min_len + 1):
    for length in range(min_len, min(n - start + 1, 200), 2):
        end = start + length - 1
        seq = s[start:end + 1]
        if is_dna_palindrome(seq):
            # ...
```

#### é—®é¢˜æè¿°

**æ—¶é—´å¤æ‚åº¦**ï¼šO(nÂ² Ã— m)
- n = åºåˆ—é•¿åº¦
- m = å¹³å‡æ£€æŸ¥é•¿åº¦ï¼ˆå¯è¾¾200ï¼‰

å¯¹äº1000bpçš„åºåˆ—ï¼š
- å¤–å±‚å¾ªç¯ï¼š~1000æ¬¡
- å†…å±‚å¾ªç¯ï¼šå¹³å‡~100æ¬¡
- æ¯æ¬¡æ£€æŸ¥DNAå›æ–‡ï¼šO(length)
- æ€»è®¡ï¼š1000 Ã— 100 Ã— 100 = **10,000,000 æ¬¡æ“ä½œ**

#### å®é™…å½±å“

- å¯¹äºçŸ­åºåˆ—ï¼ˆ<500bpï¼‰ï¼šå¯æ¥å—
- å¯¹äºä¸­ç­‰åºåˆ—ï¼ˆ500-2000bpï¼‰ï¼šè¾ƒæ…¢ï¼ˆå¯èƒ½1-5ç§’ï¼‰
- å¯¹äºé•¿åºåˆ—ï¼ˆ>2000bpï¼‰ï¼šéå¸¸æ…¢ï¼ˆå¯èƒ½10ç§’+ï¼‰

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆ1ï¼šæ—©åœä¼˜åŒ–**
```python
for start in range(n - min_len + 1):
    for length in range(min_len, min(n - start + 1, 200), 2):
        seq = s[start:start + length]
        if is_dna_palindrome(seq):
            # æ‰¾åˆ°ä¸€ä¸ªå›æ–‡åï¼Œä¸éœ€è¦ç»§ç»­æ£€æŸ¥æ›´é•¿çš„
            # ï¼ˆé™¤éæ‰©å±•åçš„åºåˆ—ä»ç„¶æ˜¯å›æ–‡ï¼Œä½†è¿™å¾ˆå°‘è§ï¼‰
            palindromes.append({...})
            # å¯ä»¥è€ƒè™‘ breakï¼Œä½†å¯èƒ½æ¼æ‰æ›´é•¿çš„å›æ–‡
```

**æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ›´æ™ºèƒ½çš„æœç´¢**
```python
# ä½¿ç”¨æ»‘åŠ¨çª—å£ + å“ˆå¸Œ
# æˆ–ä½¿ç”¨åç¼€æ ‘/åç¼€æ•°ç»„
# å¤æ‚ä½†æ›´å¿«
```

**æ¨è**ï¼šä¿æŒå½“å‰å®ç°ï¼ˆå·²ç»é™åˆ¶åˆ°200bpï¼‰ï¼Œä½†åœ¨æ–‡æ¡£ä¸­è¯´æ˜æ€§èƒ½é™åˆ¶ã€‚

---

### 4. â“ **Inverted Repeats - åˆ†ç±»è¾¹ç•Œé—®é¢˜**

#### é—®é¢˜ä½ç½®
`tools/scripts/AnalysisSequence.py:407, 424`

#### é—®é¢˜ä»£ç 
```python
if stem_len >= 10 and 4 <= loop_length <= 8:
    # Hairpin ç»“æ„
    # ...
elif stem_len >= 16 and (loop_length >= 8 or loop_length <= 3):
    # Inverted Repeats ç»“æ„
    # ...
```

#### é—®é¢˜æè¿°

**æœªè¦†ç›–çš„æƒ…å†µ**ï¼š

| stem_len | loop_length | åˆ†ç±»ç»“æœ |
|----------|-------------|----------|
| 12 | 9 | âŒ ä¸è®°å½• |
| 12 | 3 | âŒ ä¸è®°å½• |
| 15 | 9 | âŒ ä¸è®°å½• |
| 15 | 3 | âŒ ä¸è®°å½• |

**ä¸ºä»€ä¹ˆï¼Ÿ**
- `stem_len = 12`: æ»¡è¶³ `>= 10`ï¼Œä½† loop = 9 ä¸æ»¡è¶³ `4 <= 9 <= 8` âŒ
- ç¬¬äºŒä¸ªæ¡ä»¶éœ€è¦ `stem_len >= 16` âŒ

æ‰€ä»¥è¿™äº›ç»“æ„**ä¸ä¼šè¢«è®°å½•**ã€‚

#### è¿™æ˜¯Bugå—ï¼Ÿ

**å¯èƒ½ä¸æ˜¯**ï¼Œè¿™å¯èƒ½æ˜¯æœ‰æ„çš„è®¾è®¡ï¼š
- åªè®°å½•"æ ‡å‡†"çš„hairpinï¼ˆloop 4-8bpï¼‰
- åªè®°å½•"æ ‡å‡†"çš„inverted repeatï¼ˆstem >= 16, loop >= 8 or <= 3ï¼‰
- ä¸­é—´çš„ç»“æ„å¯èƒ½ç”Ÿç‰©å­¦æ„ä¹‰ä¸å¤§

#### å»ºè®®

**æ–¹æ¡ˆ1ï¼šæ·»åŠ ç¬¬ä¸‰ç±»**
```python
if stem_len >= 10 and 4 <= loop_length <= 8:
    # Hairpin
elif stem_len >= 16 and (loop_length >= 8 or loop_length <= 3):
    # Inverted Repeat
elif stem_len >= 10:  # æ•è·æ‰€æœ‰å…¶ä»–æƒ…å†µ
    # Other stem-loop structure
    # ä½ç½šåˆ†æˆ–ä¸ç½šåˆ†
```

**æ–¹æ¡ˆ2ï¼šæ”¾å®½æ¡ä»¶**
```python
if stem_len >= 10 and loop_length <= 8:  # å»æ‰ä¸‹é™
    # Hairpin
elif stem_len >= 16:  # å»æ‰ loop æ¡ä»¶
    # Inverted Repeat
```

**æ¨è**ï¼šä¿æŒå½“å‰è®¾è®¡ï¼ˆæœ‰æ„çš„ï¼‰ï¼Œä½†åœ¨æ–‡æ¡£ä¸­è¯´æ˜å“ªäº›ç»“æ„ä¼šè¢«è·³è¿‡ã€‚

---

### 5. ğŸ” **Tandem Repeats - Suffix Array æ€§èƒ½**

#### é—®é¢˜ä½ç½®
`tools/scripts/AnalysisSequence.py:116-117`

#### é—®é¢˜ä»£ç 
```python
for i in range(n):
    for unit_length in range(min_unit, n - sa[i]):
        # ...
```

#### é—®é¢˜æè¿°

**æ€§èƒ½**ï¼š
- å¤–å±‚å¾ªç¯ï¼šn æ¬¡ï¼ˆåºåˆ—é•¿åº¦ï¼‰
- å†…å±‚å¾ªç¯ï¼šå¹³å‡ (n - sa[i]) / 2 æ¬¡

å¯¹äºé•¿åºåˆ—ï¼Œè¿™ä¼šäº§ç”Ÿå¤§é‡é‡å¤æ£€æµ‹ã€‚

#### å®é™…å½±å“

- å¯¹äºçŸ­åºåˆ—ï¼ˆ<1000bpï¼‰ï¼šå¯æ¥å—
- å¯¹äºé•¿åºåˆ—ï¼ˆ>2000bpï¼‰ï¼šå¯èƒ½è¾ƒæ…¢

ä½†è¿™æ˜¯ä½¿ç”¨ suffix array æ–¹æ³•çš„å›ºæœ‰ç‰¹æ€§ã€‚

#### æ˜¯å¦éœ€è¦ä¿®å¤ï¼Ÿ

**å»ºè®®**ï¼šä¿æŒå½“å‰å®ç°ï¼Œè¿™æ˜¯åˆç†çš„ç®—æ³•å¤æ‚åº¦ã€‚

---

## ğŸ“Š é—®é¢˜ä¼˜å…ˆçº§

| é—®é¢˜ | ä¼˜å…ˆçº§ | å½±å“ | ä¿®å¤éš¾åº¦ |
|------|--------|------|----------|
| **Palindrome min_lenå¥‡æ•°** | ğŸ”´ **P0 ä¸¥é‡** | åŠŸèƒ½å®Œå…¨å¤±æ•ˆ | âœ… ç®€å• |
| **Tandem åˆå¹¶é€»è¾‘** | ğŸŸ¡ **P1 ä¸­ç­‰** | å¯èƒ½äº§ç”Ÿé”™è¯¯ç»“æœ | ğŸŸ¡ ä¸­ç­‰ |
| **Palindrome æ€§èƒ½** | ğŸŸ¢ **P2 ä½** | é•¿åºåˆ—è¾ƒæ…¢ | ğŸ”´ å›°éš¾ |
| **Inverted åˆ†ç±»è¾¹ç•Œ** | ğŸŸ¢ **P3 å¾ˆä½** | å¯èƒ½æ˜¯æœ‰æ„è®¾è®¡ | âœ… ç®€å• |
| **Tandem æ€§èƒ½** | ğŸŸ¢ **P3 å¾ˆä½** | å¯æ¥å— | ğŸ”´ å›°éš¾ |

---

## âœ… æ¨èä¿®å¤é¡ºåº

### 1. ç«‹å³ä¿®å¤ï¼šPalindrome min_len é—®é¢˜

**ä¿®å¤ä»£ç **ï¼š
```python
def find_palindrome_repeats(self, index=None, min_len=15):
    # ... (ä¿æŒæ–‡æ¡£ä¸å˜)

    s, sa, lcp = self._get_sequence_data(index)
    n = len(s)
    palindromes = []

    # ğŸ”§ ä¿®å¤ï¼šç¡®ä¿èµ·å§‹é•¿åº¦æ˜¯å¶æ•°
    start_len = min_len if min_len % 2 == 0 else min_len + 1

    # ... (å…¶ä»–ä»£ç )

    for start in range(n - start_len + 1):  # ä½¿ç”¨ start_len
        for length in range(start_len, min(n - start + 1, 200), 2):  # ä½¿ç”¨ start_len
            # ...
```

### 2. å»ºè®®ä¿®å¤ï¼šTandem åˆå¹¶é€»è¾‘

éœ€è¦æ·»åŠ é‡å¤å•å…ƒæ£€æŸ¥é€»è¾‘ã€‚

### 3. æ–‡æ¡£åŒ–ï¼šå…¶ä»–é—®é¢˜

åœ¨æ–‡æ¡£ä¸­è¯´æ˜æ€§èƒ½é™åˆ¶å’Œè®¾è®¡å†³ç­–ã€‚

---

## ğŸ§ª å»ºè®®æµ‹è¯•

### æµ‹è¯• Palindrome Bug

```python
# æµ‹è¯•1ï¼šä½¿ç”¨é»˜è®¤å‚æ•°
result = finder.find_palindrome_repeats(min_len=15)
# æœŸæœ›ï¼šèƒ½æ‰¾åˆ°DNAå›æ–‡
# å®é™…ï¼šæ‰¾ä¸åˆ°ï¼ˆBUGï¼‰

# æµ‹è¯•2ï¼šä½¿ç”¨å¶æ•°å‚æ•°
result = finder.find_palindrome_repeats(min_len=16)
# æœŸæœ›ï¼šèƒ½æ‰¾åˆ°DNAå›æ–‡
# å®é™…ï¼šåº”è¯¥èƒ½æ‰¾åˆ°
```

### æµ‹è¯• Tandem åˆå¹¶

```python
# æµ‹è¯•åºåˆ—ï¼šä¸¤ä¸ªä¸åŒçš„ä¸²è”é‡å¤ç´§é‚»
sequence = "ATCATCATCGCGCGCGC"
result = finder.find_tandem_repeats()
# æ£€æŸ¥æ˜¯å¦è¢«é”™è¯¯åˆå¹¶
```

---

## ğŸ“ æ€»ç»“

| ç®—æ³• | ä¸»è¦é—®é¢˜ | çŠ¶æ€ |
|------|----------|------|
| **Tandem Repeats** | åˆå¹¶é€»è¾‘å¯èƒ½åˆå¹¶ä¸åŒå•å…ƒ | âš ï¸ éœ€è¦æµ‹è¯• |
| **Palindrome Repeats** | ğŸ”´ **min_lenå¥‡æ•°bug - åŠŸèƒ½å¤±æ•ˆ** | âŒ éœ€ç«‹å³ä¿®å¤ |
| **Inverted Repeats** | æœªè¦†ç›–æŸäº›è¾¹ç•Œæƒ…å†µ | âœ… å¯èƒ½æ˜¯æœ‰æ„è®¾è®¡ |

---

**ç”Ÿæˆæ—¥æœŸ**: 2025-11-06
**ä¸‹ä¸€æ­¥**: ä¿®å¤ Palindrome Repeats çš„ min_len é—®é¢˜
